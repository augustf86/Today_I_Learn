# [Dreamhack Wargame] File Vulnerability Advanced for linux
### [🚩File Vulnerability Advanced for linux](https://dreamhack.io/wargame/challenges/417/)
  <img width="1070" alt="FVA for linux_description" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/10eeb994-29a0-4ed4-a571-4b3e3aa4c57a">

<br/><br/>

## 문제 파일(main.py) 분석
```python
import os, subprocess
from functools import wraps
from flask import Flask, request

app = Flask(__name__)
API_KEY = os.environ.get('API_KEY', None) # 환경 변수에 설정되어 있는 API_KEY 값을 가져옴

# key_required (데코레이터) 함수: API_KEY를 검사함
def key_required(view):
    @wraps(view)
    def wrapped_view(**kwargs):
        apikey = request.args.get('API_KEY', None) # GET 메소드로 전달한 API_KEY 파라미터의 값을 가져옴
        if API_KEY and apikey:
            if apikey == API_KEY: # API_KEY 파라미터의 값(apikey)이 환경 변수에 설정되어 있는 API_KEY와 동일한지 확인함
                return view(**kwargs)
        return 'Access Denined !'
    return wrapped_view


# index(/) 페이지
@app.route('/', methods=['GET'])
def index():
    return 'API Index'


# file 페이지
@app.route('/file', methods=['GET'])
def file():
    path = request.args.get('path', None) # 이용자가 GET 메소드로 전달한 path 파라미터의 값을 가져옴
    if path: # path 파라미터의 값이 존재하는 경우
        data = open('./files/' + path).read() # path 파라미터를 통해 ./files/ 경로로부터 파일을 읽음 (취약점이 존재하는 부분)
        return data # 읽어온 파일 데이터를 반환함
    return 'Error !'


# admin 페이지
@app.route('/admin', methods=['GET'])
@key_required # key_required 데코레이터로 인해 API_KEY를 앍고 있는 이용자만이 사용할 수 있음
def admin():
    cmd = request.args.get('cmd', None) # GET 메소드로 전달된 cmd 파라미터의 값을 가져옴
    if cmd: # cmd 파라미터의 값이 존재하는 경우
        result = subprocess.getoutput(cmd) # cmd 파라미터를 통해 시스템 명령어를 실행함
        return result # 명령어 실헹 결과를 반환함
    else:
        return 'Error !'


if __name__ == '__main__':
    app.run(host='0.0.0.0')
```
* 코드 이해를 위한 Python 개념들
    - **Decorator(데코레이터)**: 함수를 수정하지 않은 상태에서 추가 기능을 구현할 때 사용함
        + ```@```로 시작하며, 호출할 함수 위에 ```@decorator``` 형식으로 지정함
            ```python
            @decorator
            def function_name():
                # code line
            ```
        + 참고 자료: 📚 [파이썬 코딩 도장: 42.1 데코레이터 만들기](https://dojang.io/mod/page/view.php?id=2427)
    - **```subprocess``` 모듈**: 새로운 프로세스를 생성한 후 입력/출력/에러 파이프에 연결하고 반환 코드를 얻을 수 있도록 함
        + ```os.system```, ```os.spawn*```를 대체
        + subprocess.getoutput 함수
            | 형식 | 설명 |
            |-----|-----|
            | ```subprocess.getoutput(cmd, *, encoding=None, errors=None)``` | 셸에서 cmd를 실행한 후 출력(stdout과 stderr)를 반환함 |
        + 참고 자료: 📚 [subprocess 모듈](https://docs.python.org/ko/3/library/subprocess.html)


<br/><br/>

## 문제 풀이
