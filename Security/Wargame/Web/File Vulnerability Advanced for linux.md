# [Dreamhack Wargame] File Vulnerability Advanced for linux
* μ¶μ²: π© File Vulnerabiliity Advanced for lunux [π”—](https://dreamhack.io/wargame/challenges/417/)
* Reference: File Vulnerability - File Download Vulnerability (Injection - Path Traversal)
* λ¬Έμ  μ„¤λ…
  <br/><br/>
  <img width="1070" alt="FVA for linux_description" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/10eeb994-29a0-4ed4-a571-4b3e3aa4c57a">

<br/><br/>

## λ¬Έμ  νμΌ(main.py) λ° μ·¨μ•½μ  λ¶„μ„
```python
import os, subprocess
from functools import wraps
from flask import Flask, request

app = Flask(__name__)
API_KEY = os.environ.get('API_KEY', None) # ν™κ²½ λ³€μμ— μ„¤μ •λμ–΄ μλ” API_KEY κ°’μ„ κ°€μ Έμ΄

# key_required (λ°μ½”λ μ΄ν„°) ν•¨μ: API_KEYλ¥Ό κ²€μ‚¬ν•¨
def key_required(view):
    @wraps(view)
    def wrapped_view(**kwargs):
        apikey = request.args.get('API_KEY', None) # GET λ©”μ†λ“λ΅ μ „λ‹¬ν• API_KEY νλΌλ―Έν„°μ κ°’μ„ κ°€μ Έμ΄
        if API_KEY and apikey:
            if apikey == API_KEY: # API_KEY νλΌλ―Έν„°μ κ°’(apikey)μ΄ ν™κ²½ λ³€μμ— μ„¤μ •λμ–΄ μλ” API_KEYμ™€ λ™μΌν•μ§€ ν™•μΈν•¨
                return view(**kwargs)
        return 'Access Denined !'
    return wrapped_view


# index(/) νμ΄μ§€
@app.route('/', methods=['GET'])
def index():
    return 'API Index'


# file νμ΄μ§€
@app.route('/file', methods=['GET'])
def file():
    path = request.args.get('path', None) # μ΄μ©μκ°€ GET λ©”μ†λ“λ΅ μ „λ‹¬ν• path νλΌλ―Έν„°μ κ°’μ„ κ°€μ Έμ΄
    if path: # path νλΌλ―Έν„°μ κ°’μ΄ μ΅΄μ¬ν•λ” κ²½μ°
        data = open('./files/' + path).read() # path νλΌλ―Έν„°λ¥Ό ν†µν•΄ ./files/ κ²½λ΅λ΅λ¶€ν„° νμΌμ„ μ½μ (μ·¨μ•½μ μ΄ μ΅΄μ¬ν•λ” λ¶€λ¶„)
        return data # μ½μ–΄μ¨ νμΌ λ°μ΄ν„°λ¥Ό λ°ν™ν•¨
    return 'Error !'


# admin νμ΄μ§€
@app.route('/admin', methods=['GET'])
@key_required # key_required λ°μ½”λ μ΄ν„°λ΅ μΈν•΄ API_KEYλ¥Ό μ•κ³  μλ” μ΄μ©μλ§μ΄ μ‚¬μ©ν•  μ μμ
def admin():
    cmd = request.args.get('cmd', None) # GET λ©”μ†λ“λ΅ μ „λ‹¬λ cmd νλΌλ―Έν„°μ κ°’μ„ κ°€μ Έμ΄
    if cmd: # cmd νλΌλ―Έν„°μ κ°’μ΄ μ΅΄μ¬ν•λ” κ²½μ°
        result = subprocess.getoutput(cmd) # cmd νλΌλ―Έν„°λ¥Ό ν†µν•΄ μ‹μ¤ν… λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•¨
        return result # λ…λ Ήμ–΄ μ‹¤ν—Ή κ²°κ³Όλ¥Ό λ°ν™ν•¨
    else:
        return 'Error !'


if __name__ == '__main__':
    app.run(host='0.0.0.0')
```
* μ½”λ“ μ΄ν•΄λ¥Ό μ„ν• Python κ°λ…λ“¤
    - **Decorator(λ°μ½”λ μ΄ν„°)**: ν•¨μλ¥Ό μμ •ν•μ§€ μ•μ€ μƒνƒμ—μ„ μ¶”κ°€ κΈ°λ¥μ„ κµ¬ν„ν•  λ• μ‚¬μ©ν•¨
        + ```@```λ΅ μ‹μ‘ν•λ©°, νΈμ¶ν•  ν•¨μ μ„μ— ```@decorator``` ν•μ‹μΌλ΅ μ§€μ •ν•¨
            ```python
            @decorator
            def function_name():
                # code line
            ```
        + μ°Έκ³  μλ£: π“ [νμ΄μ¬ μ½”λ”© λ„μ¥: 42.1 λ°μ½”λ μ΄ν„° λ§λ“¤κΈ°](https://dojang.io/mod/page/view.php?id=2427)
    - **```subprocess``` λ¨λ“**: μƒλ΅μ΄ ν”„λ΅μ„Έμ¤λ¥Ό μƒμ„±ν• ν›„ μ…λ ¥/μ¶λ ¥/μ—λ¬ νμ΄ν”„μ— μ—°κ²°ν•κ³  λ°ν™ μ½”λ“λ¥Ό μ–»μ„ μ μλ„λ΅ ν•¨
        + ```os.system```, ```os.spawn*```λ¥Ό λ€μ²΄
        + subprocess.getoutput ν•¨μ
            | ν•μ‹ | μ„¤λ… |
            |-----|-----|
            | ```subprocess.getoutput(cmd, *, encoding=None, errors=None)``` | μ…Έμ—μ„ cmdλ¥Ό μ‹¤ν–‰ν• ν›„ μ¶λ ¥(stdoutκ³Ό stderr)λ¥Ό λ°ν™ν•¨ |
        + μ°Έκ³  μλ£: π“ [subprocess λ¨λ“](https://docs.python.org/ko/3/library/subprocess.html)
* ```/file``` νμ΄μ§€μ—μ„ μ΄μ©μκ°€ μ „λ‹¬ν• ```path``` νλΌλ―Έν„°μ κ°’μ— λ€ν• λ³„λ„μ ν•„ν„°λ§ κ³Όμ • μ—†μ΄ μ΄λ¥Ό μ΄μ©ν•΄ ```./files/``` κ²½λ΅λ΅λ¶€ν„° νμΌμ„ μ½μ–΄μ¤κΈ° λ•λ¬Έμ— <U>Path Traversal μ·¨μ•½μ </U>μ΄ λ°μƒν•¨
    - Path Traversal μ·¨μ•½μ μ„ μ΄μ©ν•΄ μ„μ κ²½λ΅μ νμΌμ„ λ‹¤μ΄λ΅λ“ν•  μ μμ (νμΌ λ‹¤μ΄λ΅λ“ μ·¨μ•½μ ) <br/> &nbsp;&nbsp; β†’ ***νμΌ λ‹¤μ΄λ΅λ“ μ·¨μ•½μ μ„ μ΄μ©ν•΄ ```API_KEY```λ¥Ό νλ“ν•κ³ , μ΄λ¥Ό μ΄μ©ν•΄ /admin νμ΄μ§€μ—μ„ μ„μ λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•λ©΄ FLAGλ¥Ό νλ“ν•  μ μμ


<br/><br/>

## λ¬Έμ  ν’€μ΄ (μµμ¤ν”λ΅μ‡)
1. ```path``` νλΌλ―Έν„°μ— ```API_KEY```λ¥Ό νλ“ν•κΈ° μ„ν• μ΅°μ‘λ κ²½λ΅λ¥Ό μ…λ ¥ν• ν›„ μ”μ²­μ„ λ³΄λƒ„
    - λ°©λ²• 1: ```key_required``` λ°μ½”λ μ΄ν„° ν•¨μμ—μ„ μ‚¬μ©ν•λ” ```API_KEY```λ” ```os.environ.get``` ν•¨μλ¥Ό μ΄μ©ν•΄ ν™κ²½ λ³€μμ—μ„ μ½μ–΄μ΄
        + λ¦¬λ…μ¤μ—μ„ ν™κ²½ λ³€μλ¥Ό μ €μ¥ν•κ³  μλ” νμΌμ€ ```/proc/self.envrion```μ΄κΈ° λ•λ¬Έμ— ν•΄λ‹Ή νμΌμ„ μ½μ–΄μ¤λ©΄ ```API_KEY```λ¥Ό νλ“ν•  μ μμ
        + λ°©λ²• 1 μν–‰ κ²°κ³Ό: file νμ΄μ§€μ ```path``` νλΌλ―Έν„°μ— ```../../../proc/self.environ```μ„ μ…λ ¥ν• ν›„ μ”μ²­μ„ λ³΄λ‚΄λ©΄ ```API_KEY=d22cb18e86fc9e23996650150461c9f794ad3a4f```λ¥Ό νλ“ν•  μ μμ
            <img width="946" alt="μµμ¤ν”λ΅μ‡1_λ°©λ²•1" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/ce65855c-d14b-43da-9b75-f3c248611590">
    - λ°©λ²• 2: GET λ©”μ†λ“μ νλΌλ―Έν„°λ΅ μ „λ‹¬λλ” ```API_KEY```λ” nginx λ΅κ·Έ νμΌμ— λ‚΄μ©μ΄ λ‚¨μ•„μμ„ κ°€λ¥μ„±μ΄ μ΅΄μ¬ν•¨
        + λ¦¬λ…μ¤μ—μ„ Nginx μ›Ή μ„λ²„μ λ΅κ·Έ νμΌμ΄ μ €μ¥λλ” κ³³μ€ ```/var/log/nginx```μ΄λ―€λ΅, ```/var/log/nginx/access.log``` νμΌμ„ μ½μ–΄μ™€ λ΅κ·Έμ— κΈ°λ΅λ κΈ°μ΅΄μ μ”μ²­ μ •λ³΄λ¥Ό ν†µν•΄ ```API_KEY```λ¥Ό νλ“ν•  μ μμ
    - νμΌ λ‚΄μ© μ°Έκ³ : π“ [File Vulnerabilities for Linux](https://github.com/augustf86/Today_I_Learn/blob/main/Security/Web%20Hacking/File%20Vulnerabilities%20for%20Linux.md) - νμΌ λ‹¤μ΄λ΅λ“ κ³µκ²©

2. 1λ² κ³Όμ •μ—μ„ νλ“ν• ```API_KEY```λ¥Ό μ΄μ©ν•΄ ```/admin``` νμ΄μ§€μ—μ„ ν”λκ·Έλ¥Ό νλ“ν•κΈ° μ„ν• λ…λ Ήμ–΄λ¥Ό μ…λ ¥ν• ν›„ μ”μ²­μ„ λ³΄λƒ„
    1. ```API_KEY``` νλΌλ―Έν„°μ— νλ“ν• κ°’μ„ λ„£κ³  ```cmd``` νλΌλ―Έν„°μ— ```ls -al /```λ¥Ό μ…λ ¥ν• ν›„ μ”μ²­μ„ λ³΄λ‚΄ ν”λκ·Έ νμΌμ μ„μΉλ¥Ό μ°Ύμ
        + ```/flag```μ— ν”λκ·Έ νμΌμ΄ μ΅΄μ¬ν•λ©°, μ‹¤ν–‰ κ¶ν•λ§ μ΅΄μ¬ν•κΈ° λ•λ¬Έμ— ν”λκ·Έ νμΌμ„ μ‹¤ν–‰ν•΄μ•Ό ν”λκ·Έλ¥Ό νλ“ν•  μ μμμ„ μ• μ μμ
            <img width="1260" alt="μµμ¤ν”λ΅μ‡2_ν”λκ·Έ μ‹¤ν–‰ κ¶ν• ν™•μΈ" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/d37627b2-8a5b-4342-9179-fad3b20b23be">
    2. ν”λκ·Έ νμΌμ μ‹¤ν–‰μ„ μ„ν•΄ ```API_KEY``` νλΌλ―Έν„°μ— νλ“ν• κ°’μ„ λ„£κ³  ```cmd``` νλΌλ―Έν„°μ— ```/flag```λ¥Ό μ…λ ¥ν•μ—¬ ν”λκ·Έ νμΌμ„ μ‹¤ν–‰ν•λ©΄ ν”λκ·Έλ¥Ό νλ“ν•  μ μμ
      <img width="1260" alt="μµμ¤ν”λ΅μ‡2_ν”λκ·Έ νμΌ μ‹¤ν–‰ κ²°κ³Ό" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/777a69c3-2ba5-4793-a444-59a8a09f02ef">
