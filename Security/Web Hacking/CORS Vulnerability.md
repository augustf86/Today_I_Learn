# CORS Vulnerability

* SOP의 한계를 극복하고 Origin 간 자원 공유를 돕기 위해 ```postMessage```, JSONP 및 CORS 정책 기술이 도입됨
    - CORS(Cross Origin Resource Sharing): **SOP 보안 정책을 우회**하여 Cross Origin 간 자원을 공유하기 위한 방법 중 하나 → ⚠️ **잘못 사용할 경우 사이트 간 공격이 가능해지는 취약점이 발생할 수 있음**
        + 웹 상에 있는 서비스에만 제약되는 것이 아님
        + 📚 [Same Origin Policy(SOP).md](https://github.com/augustf86/Today_I_Learn/blob/main/Security/Background/Same%20Origin%20Policy(SOP).md) 내용 참고

<br/>

* CORS 기술의 사용에 있어 발생할 수 있는 취약점의 종류
    | 취약점 종류 | 설명 |
    |:---:|------|
    | 현재 사이트에서 <br/> 다른 사이트로 <br/> 정보 유출 <br/> (기밀성) | CORS는 모든 정보를 공개하는 Open API뿐만 아니라 특정 대상에게만 자원을 공유하고자 하는 사이트에서도 <br/>사용할 수 있음 <br/> &nbsp;&nbsp; - 다른 사이트로부터 CORS 요청을 받을 때 **그 Origin에 대한 검사가 진행되지 않고 응답하거나 Origin에 제약이 <br/> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;없는 경우** 민감한 정보가 다른 사이트에 노출될 수 있음 |
    | 다른 사이트에서 <br/> 현재 사이트로 <br/> 변조 (무결성) | CORS 요청의 Origin에서 **신뢰할 수 있는 출처인지 확인 또는 제한하지 않거나** CORS 응답을 **그대로 사용**할 경우<br/> XSS 등의 보안 문제가 발생할 수 있음 <br/> &nbsp;&nbsp; - CORS 도입 시 어떤 사이트를 얼마나 신뢰하느냐가 결정되어야 함 <br/> &nbsp;&nbsp; - XSS 필터 등 신뢰하지 않는 입력에 대한 방어가 병행되어야 함 |

<br/><br/>

## postMessage 취약점
### Window.postMessage API
* postMessage API 도입 배경
    | 시기 | 설명 |
    |:---:|------|
    | 웹 초창기 <br/> (SOP 도입 전) | 프레임과 창들은 자유롭게 서로의 코드를 호출할 수 있었음 |
    | SOP 도입 후 | 서로 다른 오리진들은 직접적으로 리소스를 공유하지 못하게 됨 <br/> &nbsp;&nbsp; → 해결책으로 **서로 다른 Origin 간에 메시지를 주고받을 수 있는 API**가 고안됨

* postMessage API를 이용한 메세지 송수신 관련 메소드와 이벤트 → 📚 [Window: postMessage() method Docs](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) 참고
    - 메시지 전송(송신)을 위해서 대상 윈도우의 **```postMessage``` 메소드**를 호출함
        ```javascript
        targetWindow.postMessage(message, targetOrigin[, transfer])
        ```
        | 변수 | 설명 |
        |---|------|
        | ```targetWindow``` | 메시지를 보낼 대상 Window |
        | ```message``` | 메시지 객체 (함수, DOM 객체 등은 보낼 수 없음) |
        | ```targetOrigin``` | 메시지 송신 시점에 ```targetWindow```의 Origin이 ```targetOrigin```과 일치하여야 함 <br/> &nbsp;&nbsp; - ```targetOrigin```에 ```"*"```을 지정하면 Origin 검사가 이루어지지 않음 |
        | ```transfer``` | (optional) ```ArrayBuffer```나 canvas context 등 소유권을 전이할 객체의 배열을 지정 |
    - 메시지 수신을 위해서 수신하는 윈도우에서 **```message``` 전역 이벤트**를 청취함
        | 고유 속성 | 설명 |
        |---|------|
        | ```origin``` | 메시지를 송신한 Origin 반환 |
        | ```source``` | 메시지를 송신한 Window 객체 반환 |
        | ```data``` | 복사된 메시지 객체 또는 값 반환 |

* postMessage API를 이용한 메시지 송수신 예시
    ```javascript
    // 메시지 송신
    targetWindow.postMessage(message, targetOrigin);

    // 메시지 수신
    window.onmessage = function (e) {
        if (e.origin === 'https://sample.com') {
            console.log(e.data);
            e.source.postMessage('Hello World!', e.origin);
        }
    }
    ```

* ⚠️ postMessage 사용 시 주의 사항
    - ```postMessage```를 통해 ```message```로 문자열뿐만 아니라 객체 또한 주고받을 수 있음 <br/> &nbsp;&nbsp; → **보안을 위해 함수(객체 메소드 포함), DOM 노드(요소 등) 객체, 프로토 타입 및 ```get```/```set``` 속성 정보는 보낼 수 없음**
    - 전송되는 모든 객체는 복사됨 → 송신 후 객체를 변경하여도 수신하는 윈도우에서는 변경 내용을 볼 수 없음

<br/>

### Origin 미확인 시 발생할 수 있는 취약점


<br/><br/><br/><br/>
### 🔖 출처
* [드림핵 Web Hacking Advanced - Client Side] 📌 [Exploit Tech: CORS Vulnerability](https://dreamhack.io/lecture/courses/325)
