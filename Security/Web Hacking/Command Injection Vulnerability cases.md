# Command Injection Vulnerability cases
* 모든 시스템 명령어가 Command Injection에 취약한 것은 아님 → 각 함수의 특징을 정확히 이해하고 있어야 함
* 패치가 적용되었을 경우 이를 우회할 수 있는 방법을 모색하는 것이 중요함

<br/>

## ruby & perl


<br/><br/>

## PHP
* ```system``` 함수: PHP에서 시스템 명령어를 실행하기 위헤 제공하는 함수

<br/>

### escapeshellcmd 함수
* PHP에서 메타 문자를 통한 Command Injection을 방지하고 위해 사용하는 함수
    - 메타 문자가 입력되었을 때 해당 문자 앞에 ```\```을 삽입해 타 명령어를 실행할 수 없도록 함
    - 📚 [PHP escapeshellcmd documentation](https://www.php.net/manual/en/function.escapeshellcmd.php)
        ```php
        escapeshellcmd(string $command): string
        ```
        + 임의의 명령을 실행하도록 셸 명령을 속이는 데 사용할 수 있는 모든 문자열을 이스케이프함
        + 데이터가 ```exec()``` 또는 ```system()``` 함수 또는 백틱(backtick) 연산자로 전달되기 전에 사용자 입력에서 오는 모든 문자가 이스케이프되도록 하는 데 사용해야 함
        + 이스케이프될 명령(command)를 매개변수로 받아 이스케이프된 문자열을 반환함
* escapeshellcmd 함수를 이용한 PHP Command Injection 패치 예시
    - PHP Command Injection이 발생하는 예시
        ```php
        <?php
            $cmd = "ls ".$_GET['filename']." 2>&1";
            system($cmd);
        ?>
        ```
    - escapeshellcmd 함수를 이용해 PHP Command Injection 패치 예시
        ```php
        <?php
            $cmd = "ls ".escapeshellcmd($_GET['filename'])." 2> &1";
            system($cmd);
        ?>
        ```
* ```escapeshellcmd``` 함수로 입력값에 포함된 메타 문자를 이스케이프하는 경우 **메타 문자를 사용한 Command Injection**은 불가능함
    - 특정 명령어의 인자로 입력값이 전달되는 경우 공격자는 실행하려는 명령어의 옵션 또는 인자를 조작할 수 있음
        + escapeshellcmd 함수를 사용할 때 명령어의 옵션/인자를 조작하는 예시
            - ```curl 'http://sample.com/cmdInjection.php?filename=-al%20/etc/passwd;%20id'```
                + filename의 값인 ```-al%20/etc/passwd;%20id```의 메타 문자가 이스케이프 처리되어 '/etc/passwd;'와 'id' 문자열을 이름으로 가지는 파일 또는 디렉터리를 찾을 수 없다는 결과를 반환함 <br/> &nbsp;&nbsp; ⇒ ```id``` 명령어를 실행할 수 없게 막음 (Command Injection 방지)
            - ```curl 'http://sample.com/cmdInjection.php?filename=-al%20/etc/passwd'```'
                + filename의 값인 ```-al%20/etc/passwd```를 escapeshellcmd 함수로 처리한 결과 '-al /etc/passwd` 문자열이 반환되어 system 함수에 의해 ```ls -al /etc/passwd 2>&1```가 실행되어 결과를 출력함 <br/> &nbsp;&nbsp; ⇒ 인자와 옵션에 대해서는 이스케이프 처리할 수 없기 때문에 Command Injection을 이용해 정보 획득 가능

<br/>

### escapeshellarg 함수
* PHP에서 명령어의 인자를 조작할 수 없도록 하기 위해 사용하는 함수
    - 셸 인수로 사용할 문자열을 이스케이프 처리함
    - 📚 [PHP escapeshellarg documentation](https://www.php.net/manual/en/function.escapeshellarg.php)
        ```php
        escapeshellarg(string $arg): string
        ```
        + 문자열 주위에 작은 따옴표를 추가하고 기존의 작은 따옴표를 따옴표/이스케이프 처리하여 문자열을 셸 함수에 직접 전달하고 하나의 안전한 인수로 처리하도록 함
        + 사용자 입력에서 오는 셸 함수(```exec()``` 함수, ```system()``` 함수, 백틱 연산자)에 대한 개별 인수를 이스케이프하는 데 사용해야 함
        + 이스케이프될 인수(arg)를 매개변수로 받아 이스케이프된 문자열을 반환함
* escapeshellcmd 함수와 escapeshellarg 함수의 비교
    | 함수 | 예시 | 결과 |
    |---|----|----|
    | escapeshellcmd | ```var_dump(escapeshellcmd("a -h -d -e"));``` | ```string(10) "a -h -d -e"``` <br/>(전달한 입력값이 그대로 반환됨) |
    | escapeshellarg | ```var_dump(escapeshellarg("a -h -d -e"));``` | ```string(12) "'a -h -d - e'"``` <br/>(하나의 문자열(```'a -h -d -e'```)로 반환됨) |

<br/>

## PHP 공격 예시
* 모든 명령어가 인자를 조작한다고 해서 서버에 악영향을 끼치는 것은 아님
* 옵션으로 임의의 명령어를 실행할 수 있는 기능을 제공하는 프로그램의 경우 해당 프로그램의 인자를 조작할 수 있는 상황이라면 커맨드 인젝션 공격이 가능함

### zip
* 압축 파일을 생성하거나 해제하는 명령어
    - 터미널에 ```sudo apt install zip```을 통해 설치할 수 있음
    - ```zip --help```와 ```zip -h2```를 입력하여 zip 명령어에 대한 설명을 볼 수 있음
        <img width="726" alt="zip명령어" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/ef6aa67b-62a6-478f-bf7d-aa2504533abe">
* ```--unzip-command``` 옵션
    - 압축 파일을 테스트할 때 사용하는 옵션 → **인자로 전달된 명령어를 실행함**
    - EX: "sh -c id"를 인자로 전달하여 id 명령어를 실행하는 예시
        ```linux
        zip /tmp/test/zip ./practice -T --unzip-command="sh -c id"
        ```
        <img width="727" alt="zip_commandInjection" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/13e1f754-3c65-48c2-848a-bd3ff91352b0">

<br/>

### python
* 파이썬 코드를 실행시키는 명령어
    - 터미널에 ```sudo apt install python```(python3 설치 시에는 ```sudo apt install python3```)를 통해 설치할 수 있음
    - ```python --help``` 또는 ```python3 --help```를 터미널에 입력하여 python 명령어에 대한 설명을 볼 수 있음
        <img width="731" alt="python3_help" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/c5c3a5d3-e5ff-48d3-932e-a48816afa6ab">
* ```-c``` 옵션
    - 명령줄로 코드를 실행시킬 수 있는 옵션
    - EX: python 명령어의 ```-c``` 옵션을 이용한 시스템 명령어의 실행
        ```linux
        python -c '__import__("os").system("id")' input.py
        ```
        <img width="729" alt="python-c" src="https://github.com/augustf86/Today_I_Learn/assets/122844932/ddba86da-c7a5-4672-9bab-f67d29054546">

<br/>

### curl
* 프로토콜들을 이용해 URL로 데이터를 전송하여 서버에 데이터를 보내거나 가져올 때 사용하는 명령줄 도구 및 라이브러리 (인자로 전달된 URL에 접속하는 CLI 프로그램)
    - 특정 서버에서 방화벽 예외 상태를 테스트하거나 REST 서비스 테스트를 위해 사용됨
    - Linux, MacOS에 기본 탑재되어 있음 (Windows에서는 다른 편리한 프로그램이 많기 때문에 잘 사용되지 않음)
    - (우분투 리눅스) 터미널에 ```sudo apt install curl```을 입력해 설치할 수 있음
    - 자세한 설명은 [리눅스 curl 명령어]() 추가자료를 참고
* ```-o``` 옵션
    - curl 명령어의 결과를 임의 경로에 파일로 저장할 수 있게 하는 옵션
    - 예시: ```http://sample.com```에서 반환하는 데이터를 "hello.txt" 파일로 저장하는 예시
        ```linux
        curl http://sample.com -o /tmp/hello.txt
        ```
        + ```cat /tmp/hello.txt```로 데이터를 확인할 수 있음

<br/>

### wget
* HTTP, HTTPS 및 FTP 프로토콜을 사용하여 웹 서버에서 파일을 다운로드하는 데 도움을 주는 리눅스 커맨드라인 유틸리티 (전달된 URL에 접속해 파일을 다운로드하는 프로그램)
    - 다양한 옵션을 사용해 다운로드 상황을 제어함
    - (우분투 리눅스) 터미널에 ```sudo apt install wget```을 입력해 설치할 수 있음
* ```-O``` 옵션
    - wget 명령어의 실행 결과로 다운로드한 파일을 임의 경로에 저장할 수 있게 하는 옵션
    - 예시: ```http://sample.com```에서 반환하는 데이터를 "hello.txt" 파일로 저장하는 예시
        ```linux
        curl http://sample.com -O hello.txt
        ```
        + ```cat /tmp/hello.txt```로 데이터를 확인할 수 있음



<br/><br/><br/><br/>
### 🔖 출처
* [드림핵 Web Hacking Advanced - Server Side] 📌 [ExploitTech: Command Injection Vulnerability cases](https://dreamhack.io/lecture/courses/296)
