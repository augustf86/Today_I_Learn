# File Vulnerability
파일 취약점(File Vulnerability): 파일을 업로드하거나 다운로드할 때 발생하는 취약점
* 업로드와 다운로드 과정에서 발생하는 취약점으로 구분됨

<br/><br/>

## File Upload Vulnerability
공격자의 파일을 웹 서비스의 파일 시스템에 업로드하는 과정에서 발생하는 보안 취약점
* 파일 시스템 상 임의 경로에 원하는 파일을 업로드하거나 악성 확장자를 갖는 파일을 업로드할 수 있을 때 발생함 <br/>
    &nbsp;&nbsp; = 이용자가 업로드될 파일의 이름을 임의로 정할 수 있을 때 발생함
* 원하는 시스템 커맨드를 실행하는 원격 코드 실행 취약점을 유발할 수 있음
* 크게 **Path Traversal**과 **악성 파일 업로드**로 분류됨

<br/>

### Path Traversal
파일 업로드를 허용하는 대개의 서비스가 특정 디텍토리에만 업로드를 허용하는 제약을 우회하여, 임의 디렉토리에 파일을 업로드할 수 있는 취약점
* 이용자가 입력한 파일 이름을 별다른 검증 과정 없이 그대로 사용할 경우 ```../```와 같은 메타 문자를 사용하여 상위 디렉터리나 다른 디렉토리에서 파일을 업로드할 수 있음

#### Path Traversal 예시
```python
from flask import Flask, request
app = Flask(__name__)

@app.route('/fileUpload', methods=['GET', 'POST'])
def upload_file():
	if request.method == 'POST': # POST 메소드로 요청 시
        # 클라이언트가 전송한 파일을 가져와 ./uploads에 저장함
		f = request.files['file']
		f.save("./uploads/" + f.filename) # 이용자가 입력한 파일 이름을 그대로 사용하기 때문에 Path Traversal에 취약함
		return 'Upload Success'
	else:
		return """
			<form action="/fileUpload" method="POST" enctype="multipart/form-data">
				<input type="file" name="file"/>
				<input type="submit"/>
			</form>
			"""

if __name__ == '__main__':
	app.run()
```
* 정상적인 요청
    - 이용자의 HTTP 요청의 form-data
        | name | filename |
        |---|---|
        | "file" | "test.txt" |
    - 결과: uploads 디렉토리에 이용자가 업로드한 test.txt가 생성됨
* 악의적인 요청 (filename 필드를 변조)
    - 공격자의 HTTP 요청의 form-data
        | naem | filename |
        |---|---|
        | "file" | "../hack.py" |
        + 현재 디렉토리의 상위 디렉토리를 의미하는 메타 문자 ```..```이 포함되어 있음 → 상위 디렉토리에 파일이 저장됨
    - 결과: uploads의 상위 디렉토리에 공격자가 업로드한 hack.py가 생성됨
        + 기존에 존재하는 파일을 덮어쓴다면 서버가 재실행될 때 임의의 파이썬 코드를 실행할 수 있음

<br/>

### 악성 파일 업로드
이용자가 파일을 업로드할 때 이를 제대로 검사하지 않아서 발생하는 취약점
* 이용자가 올린 확장자를 별다른 검사 없이 사용할 때 발생함

#### 웹 셸(Web Shell)
웹 서버는 ```.php```, ```.jsp```, ```.asp```와 같은 확장자의 파일을 Common Gateway Interface(CGI)로 실행하고, 그 결과를 이용자에게 반환함
* 많은 웹 서버들은 php 파일에 대해 아래와 같은 핸들링을 지원함
    - 이용자가 요청한 파일의 확장자가 정규표현식을 만족하면, x-httpd-php로 핸들링하게 하는 Apache 설정 파일
        ```
        <FilesMatch ".+\.ph(p[3457]?|t|tml)$">
            SetHandler application/x-httpd-php
        </FilesMatch>
        ```
        + 정규표현식 ```.+\.ph(p[3457]?|t|tml)$```의 의미: 문자열의 끝이 .php, .php3, .php4, .php5, ..., .phtml인 경우 해당 정규표현식을 만족함
        + x-httpd-php: PHP 엔진, 요청한 파일을 실행하고 그 결과를 반환함
    - 결과: 공격자가 임의의 php 소스 파일을 **.php 확장자**로 업로드하고 GET 요청을 보낼 수 있으면 CGI에 의해 해당 코드가 실행되도록 할 수 있음



#### 악의적인 웹 리소스
* 웹 브라우저는 파일의 확장자나 응답의 Content-Type에 따라 요청을 다양하게 처리함
    * 요청한 파일의 확장자가 ```.html```이거나 반환된 Content-Type이 ```text/html```일 경우 응답은 HTML 엔진으로 처리됨
        + 공격자가 서버에 업로드한 exploit.html에 악의적인 스크립트를 삽입하면 XSS공격으로 이어질 수 있음
    * 요청한 파일의 확장자가 ```.png```, ```.jpg``` 등의 이미지 확장자이거나 Content-Type이 ```image/png``` 등일 경우 이미지로 랜더링됨

<br/><br/>

## File Download Vulnerability
웹 서비스의 파일 시스템에 존재하는 파일을 다운로드하는 과정에서 발생하는 보안 취약점
* 공격자는 웹 서비스의 파일 시스템에 존재하는 임의 파일을 다운로드 받을 수 있음
    + 설정 파일, 패스워드 파일, 데이터베이스 백업 본 등을 다운로드 하여 민감한 정보를 탈취할 수 있음
    + 다운로드 받은 파일을 이용해 2차 공격을 수행할 수도 있음
* 이용자가 다운로드할 파일의 이름을 임의로 정할 수 있을 때 발생함

<br/>

### Path Traversal
웹 서비스가 특정 디렉토리에 있는 파일만 접근하도록 허용하는 제약을 우회하여, 파일 이름을 직접 입력 받아 임의 디렉토리에 있는 파일을 다운로드 받을 수 있는 취약점
* 이용자가 입력한 파일 이름을 별다른 검증 과정 없이 그대로 사용할 경우 ```../```와 같은 메타 문자를 사용하여 상위 디렉터리나 다른 디렉토리에 존재하는 파일을 다운로드할 수 있음
* 파일 다운로드 취약점이 자주 발생하는 URL 패턴
    - ```https://file-vulenrability.com/download/?filename=note.txt```
    - ```https://file-vulnerability.com/download/?filename=../../../../../etc/password```
    - ```https://file-vulnerability.com/images.php?fn=df123dfasdfdf.png```

<br/><br/>

## File Vulnerability 방지
파일 업로드/다운로드 취약점이 발생하는 원리는 단순하지만, 공격에 사용되면 웹 애플리케이션에 임의 명령어를 실행하거나 중요 파일을 탈취할 수 있는 만큼 매우 치명적임

### 파일 업로드 취약점 방지 방법
* 업로드 디렉토리를 웹 서버에서 직접 접근할 수 없도록 하거나 업로드 디렉토리에서는 CGI가 실행되지 않도록 해야 함
* 업로드한 파일 이름을 그대로 사용하지 않고 ```basepath```와 같은 함수를 통해 파일 이름을 검증한 후 사용함
* 허용할 확장자를 명시해 그 외의 확장자는 업로드될 수 없도록 해야 함
    - 동적 리소스의 확장자를 제한하면, 파일 업로드 취약점을 통한 RCE 공격으로부터 서버를 보호할 수 있음
* AWS, Azure, GCP 등의 정적 스토리지를 이용함
    - 서버의 파일 시스템을 이용하지 않음 → 파일 업로드 취약점이 웹 서버 공격으로 이어지는 것을 예방할 수 있음

### 파일 다운로드 취약점 방지 방법
* 요청된 파일 이름을 ```basepath```과 같은 함수를 통해 검증
* 파일 이름과 1:1 맵핑되는 키를 만들어 이용자로부터 파일 이름이 아닌 키를 요청하도록 해야 함

<br/><br/>
