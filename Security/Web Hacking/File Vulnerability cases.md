# File Vulnerability cases
 📌 파일과 관련된 취약점이 발생했을 때 읽거나 쓸 파일들 → [File Vulnerabilities for Windows](https://github.com/augustf86/Today_I_Learn/blob/main/Security/Web%20Hacking/File%20Vulnerabilities%20for%20Windows.md), [File Vulnerabilities for Linux](https://github.com/augustf86/Today_I_Learn/blob/main/Security/Web%20Hacking/File%20Vulnerabilities%20for%20Linux.md) 참고 <br/>
 📌 **파일 취약점**: 파일 업로드 및 다운로드가 가능하다면 웹 셸을 통해 서버를 장악하거나 정보를 수집하는 등의 행위를 할 수 있음

<br/>

* 운영 체제를 비롯해 거의 모든 응용 프로그램은 파일에 의존해 실행됨
    - 일부 기능은 파일에 따라서 실행되는 코드가 달라짐 → 다양한 방법으로 악의적인 행위를 할 수 없도록 함
    - 파일과 관련된 취약점을 모두 막기 위해 필요한 요구사항
        + [기본] 응용 프로그램의 기능을 모두 이해하는 것
            - 소프트웨어에 대한 이해 부족으로 잘못된 방식으로 검사할 경우 의도한 기능조차 수행되지 않는 가용성 문제가 발생하거나 검사가 우회될 수 있음
        + 운영 체제에 대한 이해

<br/><br/>

## 우회 공격
* 널 문자
    - C 언어의 널(NULL): 문자열의 끝을 나타내거나 값을 초기화하는 용도로 사용되는 문자
        + 대부분의 웹 프로그래밍 언어에서도 널 문자를 사용할 수 있음
        + URL의 파라미터에 ```%00```을 삽입해 데이터를 전송할 수 있음
    - 운영 체제에서 파일명에 널 문자가 포함될 경우 널 문자가 위치한 곳을 파일명의 끝으로 인식함
        + 파일명에 널 문자가 포함되었을 때 운영 체제의 해석
            | URL 인코딩 입력 | C 문자열 표기 | 실제 인식된 파일 |
            |---|---|---|
            | ```foo/bar.jpg``` | ```"foo/bar.jpg"``` | ```foo/bar.jpg``` |
            | ```hello%00world``` | ```"hello\0world"``` | ```hello``` |
            | ```baz/qux.cfg%00.jpg``` | ```"baz/qux.cfg\0.jpg"``` | ```baz/qux.cgf``` |
        + 웹 응용 프로그램에서 널 문자를 허용하고 파일명의 끝에 있는 문자열로 확장자를 판단하면 공격자는 실제 확장자 뒤에 널 문자를 삽입해 확장자 검사를 우회하고 악의적인 행위가 가능함
        + 널 문자 검사
            | 종류 | 설명 |
            |---|------|
            | 아파치 등의 유명 웹 서버 | 널 문자가 포함된 요청이 들어올 경우 ```400 Bad Request``` 응답을 반환하고 기능을 수행하지 않음 |
            | 파이썬, PHP 등 다양한 언어에서 <br/>제공하는 라이브러리 | 파일명에 널 문자가 포함되어 있는지 확인함 |
            | 외부 라이브러리 | 널 문자가 포함되어 있는지 검사가 이뤄지지 않는 경우가 있음 <br/> &nbsp;&nbsp; → **파일을 입력받을 경우 입력값에 널 문자 또는 불필요한 특수 문자가 포함되어 있는지 검사하는 것을 권장함** |

<br/>

* Path Traversal: 업로드 및 다운로드 경로를 조작하는 공격 방식
    - 이용자가 업로드하거나 다운로드 할 파일을 지정할 수 있을 때 사용할 수 있음
    - 윈도우와 유닉스 계열의 운영 체제에서 존재하는 특수한 의미를 가진 디렉토리
        | 디렉터리 명칭 | 의미 | 예시 |
        |---|----|----|
        | ```.``` | 현재 디렉터리 | ```foo/. (= foo)``` <br/> ```foo/bar/././baz (= foo/bar/baz)``` |
        | ```..``` | 상위 디렉터리 | ```bar/baz/.. (= bar)``` <br/> ```alpha/../beta (=beta)``` <br/> ```foo/.. (= .)``` <br/> ```foo/bar/baz/qux/../../quux (= foo/bar/quux)``` <br/> ```/home/../../../../../ (= /)``` |
        + 웹 응용프로그램에서 ```.```, ```..``` 디렉터리를 검사하지 않으면 공격자는 상위 경로에 존재하는 파일에 접근해 악의적인 행위가 가능함
        +  Windows OS와 Linux OS의 차이점
            | 운영 체제 | 설명 |
            |---|------|
            | 윈도우 | ```foo\bar\..\baz```를 입력했을 때 ```bar``` 디렉터리가 존재하지 않아도 ```foo\baz``` 디렉터리에 접근할 수 있음 |
            | 리눅스 | 존재하지 않는 디렉터리가 포함될 경우 에러를 출력함 |
            - 서로 다른 운영 체제에서 같은 코드로 작성된 프로그램 배포 시 이러한 점을 인지하고 시큐어 코딩을 적용해야 함

<br/>

* 정규식 확장자 검사
    - 웹 서버는 파일의 확장자에 따라서 데이터를 처리하는 방식이 다름
        + 파일의 확장자: ```.``` 문자 뒤에 따라오는 문자열
            - 어디든지 위치할 수 있으며, 여러 개 포함할 수 있음
            - 다양한 값을 입력할 수 있음 → 웹 서버와 응용 프로그램은 확장자를 인식하는 알고리즘이 서로 다름
        + 확장자를 인식하는 정규식의 예시
            | 파일명 | ```(\..*)``` | ```(\.[^.]*)``` | ```(\.[^.]*)$``` | ```[^.](\.[^.]*)$``` |
            |---|---|---|---|---|
            | no-extension | - | - | - | - |
            | dream.php | ```.php``` 인식 | ```.php``` 인식 | ```.php``` 인식 | ```.php``` 인식 |
            | dream.tar.gz | ```.tar.gz``` 인식 | ```.tar.gz``` 인식 | ```.gz``` 인식 | ```.gz``` 인식 |
            | .bashrc | ```.bashrc``` 인식 | ```.bashrc``` 인식 | ```.bashrc``` 인식 | - |
            | dream.jpg.php | ```.jpg.php``` 인식 | ```.jpg.php``` 인식 | ```.php``` 인식 | ```.php``` 인식 |
            | .php | ```.php``` 인식 | ```.php``` 인식 | ```.php``` 인식 | - |
    - 정규식 확장자 검사 우회
        + 정규식을 이용한 검사는 확장자, IP 주소, 도메인 주소 등을 검사할 때 많이 사용함
        + 정규식을 사용할 때 주의해야 하는 점
            - 잘못된 정규식을 작성할 경우 의미 없는 방어책이 될 수 있음
                | 정규식 | 설명 및 예시 |
                |---|------|
                | ```(\..*)``` <br/> ```(\.[^.]*)``` | ```.``` 문자 뒤에 위치한 모든 부분 문자열을 찾음 <br/> &nbsp;&nbsp; - 우회 예시: "hello.jpg.php"라는 파일 처리 시 ```.php```를 분리하지 못하고 ```.jpg.php```를 하나의 확장자로 인식 |
                | ```(\.[^.]*)$``` | 가장 마지막에 위치한 ```.```을 기준으로 문자열을 찾음 <br/> &nbsp;&nbsp; - 예시1: "hello.jpg.php" 파일 처리 시 ```.php```를 찾아냄 <br/> &nbsp;&nbsp; - 예시2: ".htaccess" 파일 처리 시 "htaccess" 자체를 확장자로 인식 (올바르지 않은 결과) |
                | ```[^.](\.[^.]*)$``` | 가장 마지막에 위치한 ```.```을 기준으로 이후에 있는 문자열을 모두 찾고, 시작 부분에 위치한 ```.```을 무시함 <br/> &nbsp;&nbsp; - 두번째 행의 정규식을 보완한 형태 <br/> &nbsp;&nbsp; - 웹 서버가 확장자만 있는 파일명을 모두 확장자로 인식한다면 우회 가능성이 있음 |
            - 일부 정규식에서는 ```$``` 문자가 문자열의 끝이 아닌 줄의 끝을 의미함
                + 예시: "dream.jpg\nwebshell.php" → ```.jpg```까지만 인식하므로 이를 공격할 때 ```%0a```를 삽입해 정규식을 우회할 수 있음

<br/>

* 문자열 치환 우회
    - 파일의 확장자에 따라서 웹 서버가 처리하는 방식이 다름
        | 파일의 확장자 | 설명 |
        | ```.php``` 확장자를 가진 파일 | 웹 서버에서 PHP 스크립트로 인식해 이를 처리하기 위한 핸들러를 실행함 |
    - 실행 가능한 파일을 이용자가 직접 서버에 업로드할 수 있을 경우 웹 쏄을 비롯해 다양한 악의적인 행위가 가능함 → 대다수의 웹 서비스는 실행과 관련된 확장자를 가진 파일의 업로드를 막거나 치환하여 스크립트의 실행을 방지함
        + EX: ```.php``` 확장자를 가지는 파일명의 업로드 방지를 위한 해당 문자열 공백 치환
            | 원본 | 치환 과정 | 치환 결과 |
            |---|---|---|
            | file.jpg | 제거할 문자열이 존재하지 않음 | file.jpg |
            | websehll.php | ```.php```를 제거함 | webshell |
            | webshell.ph.phpp | ```.ph.phpp```에서 중간의 ```.php```를 제거함 | webshell.php |
            - 단순히 공백으로 치환할 경우 이를 역으로 이용해 ".php" 문자열을 완성시킬 수 있음 <br/> &nbsp;&nbsp; → ⚠️ 공백 치환을 사용할 경우 해당 키워드 내 키워드를 중복 사용하여 확장자 검사를 우회하고 공격할 수 있음


<br/>

* Windows OS: NTFS Alternative Data Stream
    - 프로세스뿐만 아니라 파일 시스템에서도 **Fork**라는 개념이 등장함
        + 압축한 파일과 같이 한 파일에 메타 데이터를 포함한 다양한 데이터를 포함시킬 수 있음
    - New Technology File System(NTFS): 윈도우 NT 계열의 운영 체제가 사용하는 파일 시스템
        + Alternatvie Data Stream(ADS) 영역을 제공함
            - 등장 배경
                + macOS(맥킨토시) HFS 파일 시스템과의 호환성을 목적으로 등장함
                + 파일에 사용되는 기본 스트림 외에 파일이 필요로하는 파일의 아이콘 등 부가적인 데이터를 다른 스트림에 추가로 저장할 수 있음
                    - 파일이 ```$DATA``` 속성을 하나 이상 가질 수 있는데, 추가적으로 존재하는 ```$DATA``` 속성을 ADS라고 함
            - 한 파일에 여러 가지 데이터를 각 데이터 스트림에 감출 수 있음 → 악성코드를 삽입하는 데에 많이 이용되었음
                + 텍스트 데이터나 실행 파일의 데이터 등을 은닉하는 등 악의적인 목적으로 사용됨
                + ADS를 활용하는 멀웨에(악성 프로그램)들이 지속적으로 발견되었기 때문에 대다수의 보안 솔루션들이 ADS를 탐지함
        + ADS 구문
            - ADS의 기본 형태: ```ADS Sample.txt : Memo.txt``` (파일명 뒤에 콜론이 붙고 뒤에 ADS 식별자가 붙는 형식)
            - 구문 예시
                | 구문 | 설명 |
                |---|------|
                | ```Filename:Stream``` | ```Filename```의 스트림 ```Stream```을 참조함 |
                | ```Filename:Stream:$DATA``` | ```Filename:Stream```과 같은 의미 |
                | ```Filename:``` | ```Filename```의 기본 스트림을 참조함 |
                | ```Filename::$DATA``` | ```Filename:```과 같은 의미 |
                | ```Dirname::$INDEX_ALLOCATION``` | 해당 파일을 쓰게 되면 파일 대신 디렉터리(Dir)가 생성됨 <br/> &nbsp;&nbsp; - ```$INDEX_ALLOCATION```: NTFS 내부에서 관리하는 디렉터리 인덱스(데이터베이스 인덱스와 유사한 개념)의 속성 타입 |
                | ```Dirname:$I30:$INDEX_ALLOCATION``` | 해당 파일을 쓰게 되면 파일 대신 디렉터리(Dir)가 생성됨 <br/> &nbsp;&nbsp; - ```$I30```: 속성 ```0x30```(```$FILE_NAME```)의 인덱스(```I```) |
                | ```Filename:Attrname:$AttrType``` | 바로 위 구문의 기본형태 <br/> &nbsp;&nbsp; - NTFS 데이터 스트림은 실제로는 ```$DATA``` 타입의 속성을 의미함 <br/> &nbsp;&nbsp; - 스트림명: 속성의 명칭을 의미함 |
    - NTFS Alternative Data Stream을 이용한 우회
        + ADS 특징을 이용해 파일 확장자 검사를 우회하고 공격할 수 있음
            - 웹 애플리케이션이 외부로부터 입력받은 파일을 검사할 때는 제일 마지막에 위치한 ```.``` 문자를 기준으로 확장자를 검사함
                | 공격자가 전달한 파일 | 운영 체제에 의한 ```.``` 문자 제거 결과 | 최종 결과 |
                |---|---|---|
                | ```Shell.php::$DATA.``` | ```Shell.php::$DATA``` <br/> &nbsp;&nbsp; → ADS에서 기본 스트림을 참조하는 구문 | ```Shell.php``` |

<br/>

* Windows OS: 와일드카드
    - ```FindFirstFile*```과 ```FindNextFile*``` API를 제공함
        + 파일 및 디렉터리를 탐색하고 열람하기 위한 변수
        + ```*```와 ```?```와 같은 와일드카드 문자를 지원함 → ⚠️ 다양한 변수들이 발생할 수 있기 때문에 각별한 주의가 필요함
        + 와일드카드 문자 외에도 문서화되지 않은 문자를 추가로 지원함
            - 예시: ```Web<<```, ```Web"Config```을 이용해 Web.config 파일에 접근할 수 있음
    - [PHP Zend Virtual CMD 기능] 파일의 절대 경로를 ```Find*File*``` API를 사용해 불러와 와일드카드 규칙을 적용받음
    - 와일드카드 규칙
        | 와일드 카드 | 설명 | 예시 |
        |---|------|---|
        | * | 0개 이상의 문자를 매칭함 <br/> &nbsp;&nbsp; - 문자의 패턴이 ```*.```인 경우 ```.```은 매칭되지 않음 | ```Foo*r``` → ```Foo.bar``` |
        | ? | 확장자 문자 이전 1개의 문자를 매칭함 | ```Q?x``` → ```Qux``` <br/> ```Fo?``` → ```Foo```, ```Fo``` |
        | \< | ```*``` 문자와 유사하지만 파일명과 확장자를 건너뛰어 매칭하지 않음 <br/> &nbsp;&nbsp; - ```.``` 문자는 기본 파일명의 일부이지만, 파일명이 ```.```로 시작하는 경우에는 해당 문자를 확장자의 일부로 해석함 | ```Fo<.X<``` → ```Foo.XLS``` |
        | \> | ```?.```와 같은 기능을 함 <br/> &nbsp;&nbsp; - ```.``` 문자 뒤에 위치할 경우 파일의 끝은 매칭하지 않음 | ```Qux.>``` → ```Qux.Z``` |
        | \" | ```.``` 문자를 매칭함 | ```File"txt``` → ```File.txt``` |
      
<br/><br/>

## 파일 삭제 공격
* 임의 파일을 삭제할 수 있는 취약점이 존재할 경우 가능한 공격들
    - 운영 체제 또는 응용 프로그램의 중요 정보를 포괄하는 파일을 삭제하면 서비스를 마비시킬 수 있음
    - 원격 코드 실행까지 이어지도록 할 수 있음
* 일부 CMS 서비스들은 설정 파일을 특정 파일로 관리한다는 점을 이용함
    + EX: gnuboard - "config.php" 또는 "dbconfig.php" 등의 파일에서 기본 설정들을 관리함
        - 해당 파일에서 데이터베이스 연결 정보를 포괄하고 있음 → 서버에서 없어져서는 안될 파일 중 하나임
        - 삭제 시 데이터베이스에서 데이터를 가져오지 못하므로 gnuboard에서는 **해당 파일을 생성하는 [설치 페이지](https://github.com/gnuboard/gnuboard5/blob/f83d336e0ba0b06e1b3b2886c4783049c65b2f08/common.php#L148-L199)로 리다이렉션함**
            + 🚩 *공격자는 설치 페이지에서 데이터베이스의 연결 정보를 자신의 서버로 등록함 → 이용자의 정보를 탈취하거나 다른 기능과 연계해 원격 코드 실행까지 수행할 수 있음*
    + 공격 대상이 오픈 소스 소프트웨어라면 해당 소프트웨어의 중요한 파일을 탐색하지 않고도 쉽게 알아낼 수 있음


<br/><br/><br/><br/>
### 🔖 출처
* [드림핵 Web Hacking Advanced - Server Side] 📌 [ExploitTech: File Vulnerability cases](https://dreamhack.io/lecture/courses/307)
