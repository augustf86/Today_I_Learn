# Bypass WAF

각 DBMS 별로 방화벽을 우회하기 위한 방법
* 방화벽 적용 시 얻는 이점
    - 악성 트래픽을 유발하는 디도스와 데이터베이스와 관련된 SQL Injection, 자바 로깅 라이브러리에서 발생한 log4j 등의 **공격을 탐지하고 접속을 차단함**
* **Web Application Firewall**(**WAF**): 웹 애플리케이션에 특화된 방화벽 (= 웹 방화벽)
    - 공격에 사용되었던 코드, 즉 주요 키워드를 기반으로 탐지함
        + 키워드를 이용해 탐지하는 방식은 근본적인 취약점을 해결할 수 없다는 한계가 존재함
    - 방화벽이 적용된 웹 서비스에서는 SQL Injection 취약점이 발생하더라도 공격을 최소화할 수 있음
        + 취약점은 여전히 존재하는 상태이기 때문에 SQL 문을 조작하여 방화벽을 우회하고 공격할 수 있음
    - 웹 방화벽의 장점과 단점
        + 취약점을 이용한 공격의 피해를 최소화하는 장점이 있음
            - 알려진 공격 키워드를 탐지, 과도한 트래픽이 발생할 경우 트래픽 과부하가 발생하는 IP를 차단
        + 단순한 공격을 막기 위해 방화벽을 도입한다면 가용성 침해, 비용 낭비 등이 발생할 수 있다는 단점이 있음
            - 방화벽을 도입하기 위해서는 보호가 필요한 서버를 지정하고, 서비스에서 발생하는 트래픽의 용량을 측정하는 등의 과정이 필요함 <br/> &nbsp;&nbsp;→ 시간과 비용이 발생함

<br/><br/>

## 탐지 우회
### 대소문자 검사 미흡
SQL은 데이터베이스와 컬럼명을 포함해 질의문의 **대소문자를 구분하지 않고** 실행함
* 방화벽에서 대문자 키워드만 필터링하는 경우 소문자를 사용해 이를 우회할 수 있음
    ```sql
    -- 방화벽에서 "UNION"만 필터링하는 경우
    SELECT 1 union SELECT 1, 2, 3 -- 소문자 키워드를 사용하여 필터링 우회 가능
    ```
* 방화벽에서 소문자, 대문자 키워드를 모두 검사할 경우 대소문자를 혼용하여 우회할 수 있음
    ```sql
    -- 방화벽에서 "UNION", "union"을 검사하는 경우
    selEcT 1 UnIoN SeLecT 1, 2, 3 -- 대소문자를 혼용하여 사용함 → 필터링 우회 가능
    ```

<br/>

### 탐지 과정 미흡
방화벽에서 악성 키워드를 탐지했을 때 악성 키워드가 포함된 요청을 거부하거나 **내부에서 치환 과정을 거친 후 요청을 처리**할 수 있음
* 방화벽에서 특정 키워드를 탐지하여 공백으로 치환할 경우 키워드 내부에 키워드를 중첩하여 작성하는 방법으로 이를 우회할 수 있음
    ```sql
    -- 방화벽에서 "UNION", "union"을 탐지하고 공백으로 치환할 경우 (단, 검사는 반복해서 수행하지 않음)
    SELECT 1 UNunionION SELECT 1, 2, 3; -- 결과: SELECT 1 UNION SELECT 1, 2, 3; (필터링 결과로 쿼리문이 완성되어 내부에서 정상적으로 처리됨)
    ```

<br/>

### 문자열 검사 미흡
일반적인 상황에서 "admin"이라는 문자열을 사용하는 경우는 많지 않기 때문에 방화벽에서 "admin" 키워드의 포함 여부를 검사함
* 방화벽에서 특정 키워드를 탐지하는 경우 해당 문자열을 뒤집거나 이어붙이거나 16진수로 표현하는 등의 방법으로 이를 우회할 수 있음
    ```sql
    -- 방화벽에서 "admin" 키워드를 탐지하는 경우
    SELECT REVERSE('nimda'); -- REVERSE 함수 결과 인자로 주어진 문자열이 뒤집히면 'admin'이 되므로 필터링을 우회할 수 있음
    SELECT CONCAT('adm', 'in'); -- CONCAT 함수 결과 인자로 주어진 두 문자열이 합쳐져서 'admin'을 완성하므로 필터링을 우회할 수 있음
    SELECT x'61646d696e', 0x61646d696e; -- 'admin'을 16진수로 변환한 값이 '61646d696e'이므로 필터링을 우회할 수 있음
    ```

<br/>

### 연산자 검사 미흡
일반 이용자의 입력값에는 연산자가 필요하지 않으므로 방화벽에서 "AND", "OR"와 같은 연산자 키워드의 포함 여부를 검사함
* 방화벽에서 연산자 키워드를 탐지할 경우 연산자를 의미하는 기호 등으로 바꿔서 입력하면 이를 우회할 수 있음
    ```sql
    -- 방화벽에서 "AND", "OR" 연산자 키워드의 포함 여부를 검사하는 경우
    SELECT 1 && 1; -- AND 키워드를 의미하는 기호인 &&을 사용하여 검사를 우회함
    SELECT 1 || 1; -- OR 키워드를 의미하는 기호인 ||을 사용하여 검사를 우회함
    ```
    - ^, =, !=, %, /, *, &, &&, |, ||, >, <, XOR, DIV, LIKE, RLIKE, REGEXP, IS, IN, NOT, MATCH, AND, OR, BETWEEN, ISNULL 등의 연산자를 사용할 수 있음

<br/>

### 공백 탐지
공백을 허용하는 경우 공격자가 SQL Injection을 통해 다양한 함수와 또 다른 쿼리를 삽입해 의도하지 않은 결과가 나타날 수 있으므로 공백 문자가 필요하지 않는 경우에 이를 검사함
* 방화벽에서 공백 문자를 검사하는 경우 주석이나 Back Quote 등을 이용하여 이를 우회할 수 있음
    ```sql
    -- 방화벽에서 공백 문자 포함 여부를 검사하는 경우
    SELECT/**/'abc'; -- SELECT 구문과 'abc' 문자열 사이에 주석을 나타내는 /**/를 삽입해 공백을 대신함
    SELECT`username`,(password)FROM`users`WHERE`username`='admin'; -- Back Quote(`)를 사용하여 공백 없이 쿼리를 실행시킬 수 있음
    ```

<br/><br/>
